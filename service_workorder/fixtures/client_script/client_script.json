[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Invoice",
  "enabled": 1,
  "modified": "2024-06-01 00:00:00.000000",
  "module": "Ag Docs",
  "name": "service_charge_purchase inv",
  "script": "(function() {\n    var DOC = 'Purchase Invoice';\n    var CHILD = 'Purchase Invoice Item';\n    var DOC_TOTAL_FIELD = 'custom_total_with_service_charge';\n    var ITEM_TOTAL_FIELD = 'custom_total_with_service_charge';\n    var ITEM_SC_FIELD = 'custom_service_charge';\n    var SLAB_FIELD = 'custom_service_charge_slab';\n    var scheduleTaxRefresh = frappe.utils.debounce(function(frm) {\n        frm.trigger('calculate_taxes_and_totals');\n    }, 200);\n\n    frappe.ui.form.on(DOC, {\n        refresh: function(frm) {\n            recalc_all_rows(frm);\n        },\n        customer: function(frm) {\n            load_service_charge_slab(frm);\n        },\n        items_add: function(frm, cdt, cdn) {\n            recalc_row(frm, cdt, cdn);\n        },\n        items_remove: function(frm) {\n            compute_totals(frm);\n        }\n    });\n\n    frappe.ui.form.on(CHILD, {\n        item_code: function(frm, cdt, cdn) {\n            apply_service_charge_from_slab(frm, cdt, cdn);\n        },\n        qty: function(frm, cdt, cdn) {\n            recalc_row(frm, cdt, cdn);\n        },\n        rate: function(frm, cdt, cdn) {\n            recalc_row(frm, cdt, cdn);\n        },\n        custom_service_charge: function(frm, cdt, cdn) {\n            recalc_row(frm, cdt, cdn);\n        }\n    });\n\n    function load_service_charge_slab(frm) {\n        if (!frm.doc.customer) {\n            frm.set_value(SLAB_FIELD, '');\n            compute_totals(frm);\n            return;\n        }\n\n        frappe.db.get_value('Customer Service Charge Link', {\n            customer: frm.doc.customer,\n            enabled: 1\n        }, 'service_charge_slab').then(function(r) {\n            var slab = (r && r.message && r.message.service_charge_slab) || '';\n            frm.set_value(SLAB_FIELD, slab);\n            (frm.doc.items || []).forEach(function(row) {\n                apply_service_charge_from_slab(frm, row.doctype, row.name);\n            });\n        }).catch(function(err) {\n            console.error('Service charge slab fetch failed', err);\n            frm.set_value(SLAB_FIELD, '');\n        });\n    }\n\n    function apply_service_charge_from_slab(frm, cdt, cdn) {\n        var row = frappe.get_doc(cdt, cdn);\n        if (!row) return;\n\n        var slab = frm.doc[SLAB_FIELD];\n        if (!row.item_code || !slab) {\n            frappe.model.set_value(cdt, cdn, ITEM_SC_FIELD, 0);\n            recalc_row(frm, cdt, cdn);\n            return;\n        }\n\n        frappe.call({\n            method: 'service_workorder.api.get_service_charge_from_slab',\n            args: {\n                slab_name: slab,\n                item_code: row.item_code\n            }\n        }).then(function(r) {\n            var charge = (r && r.message && r.message.service_charge) ? flt(r.message.service_charge) : 0;\n            frappe.model.set_value(cdt, cdn, ITEM_SC_FIELD, charge);\n            recalc_row(frm, cdt, cdn);\n        }).catch(function(err) {\n            console.error('Service charge fetch error', err);\n            frappe.model.set_value(cdt, cdn, ITEM_SC_FIELD, 0);\n            recalc_row(frm, cdt, cdn);\n        });\n    }\n\n    function recalc_all_rows(frm) {\n        (frm.doc.items || []).forEach(function(row) {\n            recalc_row(frm, row.doctype, row.name);\n        });\n    }\n\n    function recalc_row(frm, cdt, cdn) {\n        var row = frappe.get_doc(cdt, cdn);\n        if (!row) return;\n\n        var qty = flt(row.qty);\n        var rate = flt(row.rate);\n        var serviceCharge = flt(row[ITEM_SC_FIELD]);\n\n        var serviceTotal = qty * serviceCharge;\n        var totalWithService = (qty * rate) + serviceTotal;\n\n        frappe.model.set_value(cdt, cdn, ITEM_TOTAL_FIELD, totalWithService);\n        compute_totals(frm);\n    }\n\n    function compute_totals(frm) {\n        var totalWithService = 0;\n        var totalServiceCharge = 0;\n\n        (frm.doc.items || []).forEach(function(row) {\n            totalWithService += flt(row[ITEM_TOTAL_FIELD]);\n            totalServiceCharge += flt(row[ITEM_SC_FIELD]) * flt(row.qty);\n        });\n\n        frm.set_value(DOC_TOTAL_FIELD, totalWithService);\n        sync_service_charge_tax(frm, totalServiceCharge);\n    }\n\n    function sync_service_charge_tax(frm, amount) {\n        var tax_row = get_service_charge_tax_row(frm);\n        if (!tax_row) return;\n\n        var conversionRate = flt(frm.doc.conversion_rate || 1);\n        var baseAmount = flt(amount) * conversionRate;\n\n        tax_row.tax_amount = amount;\n        tax_row.base_tax_amount = baseAmount;\n        tax_row.tax_amount_after_discount_amount = amount;\n        tax_row.base_tax_amount_after_discount_amount = baseAmount;\n\n        frm.refresh_field('taxes');\n        scheduleTaxRefresh(frm);\n    }\n\n    function get_service_charge_tax_row(frm) {\n        var taxes = frm.doc.taxes || [];\n        for (var i = 0; i < taxes.length; i++) {\n            var chargeType = taxes[i].charge_type || '';\n            if (chargeType.toLowerCase() === 'actual') {\n                return taxes[i];\n            }\n        }\n        return null;\n    }\n})();\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Invoice",
  "enabled": 1,
  "modified": "2025-11-08 17:29:58.767483",
  "module": "Ag Docs",
  "name": "naming_filter",
  "script": "(function() {\n    frappe.ui.form.on('Sales Invoice', {\n        customer: function(frm) {\n            if (!frm.doc.customer) {\n                frm.set_value('naming_series', '');\n                return;\n            }\n            frappe.db.get_value('Customer', frm.doc.customer, 'customer_group', function(r) {\n                var group = '';\n                if (r) {\n                    if (typeof r.customer_group !== 'undefined') {\n                        group = r.customer_group;\n                    } else if (r.message && typeof r.message.customer_group !== 'undefined') {\n                        group = r.message.customer_group;\n                    }\n                }\n                var series = 'INV-.YYYY.-';\n                if (group === 'VAT') {\n                    series = 'ACC-SINV-.YYYY.-';\n                } else if (group === 'NON VAT') {\n                    series = 'INV-.YYYY.-';\n                }\n                frm.set_value('naming_series', series);\n            });\n        }\n    });\n})();",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Customer Employee Registration",
  "enabled": 1,
  "module": "Ag Docs",
  "name": "customer_employee_registration_sr_links",
  "script": "frappe.provide(\"service_workorder.employee_actions\");\n\nObject.assign(service_workorder.employee_actions, {\n    ensureMakeMethods(frm) {\n        frm.make_methods = frm.make_methods || {};\n        frm.make_methods[\"Service Request\"] = () => this.createServiceRequest(frm);\n    },\n\n    buildDepartmentNumber(frm) {\n        const parts = [];\n        if (frm.doc.dep_no1) {\n            parts.push(frm.doc.dep_no1);\n        }\n        if (frm.doc.dep_no2) {\n            parts.push(frm.doc.dep_no2);\n        }\n        return parts.join(\"/\") || \"\";\n    },\n\n    async hasExistingDraft(frm) {\n        if (!frm.doc.customer_name) {\n            return null;\n        }\n        const existing = await frappe.db.get_list(\"Service Request\", {\n            filters: {\n                customer: frm.doc.customer_name,\n                dep_emp_name: frm.doc.name,\n                docstatus: 0,\n            },\n            fields: [\"name\"],\n            limit: 1,\n        });\n        return existing && existing.length ? existing[0] : null;\n    },\n\n    async guardCreation(frm) {\n        if (frm.is_new()) {\n            frappe.msgprint(__('Please save this Employee Registration before creating a Service Request.'));\n            return false;\n        }\n\n        if (!frm.doc.customer_name) {\n            frappe.msgprint(__('Please select a Customer before creating a Service Request.'));\n            return false;\n        }\n\n        if (frm.doc.employee_type === 'Dependent' && !frm.doc.dep_emp_name) {\n            frappe.msgprint(__('Select the linked employee before creating a Service Request for a dependent.'));\n            return false;\n        }\n\n        return true;\n    },\n\n    async createServiceRequest(frm) {\n        if (!(await this.guardCreation(frm))) {\n            return;\n        }\n\n        const existing = await this.hasExistingDraft(frm);\n        if (existing) {\n            frappe.msgprint({\n                title: __('Draft Already Exists'),\n                indicator: 'orange',\n                message: __('Opening Service Request {0}', [existing.name]),\n            });\n            frappe.set_route('Form', 'Service Request', existing.name);\n            return;\n        }\n\n        frappe.model.with_doctype('Service Request', () => {\n            const doc = frappe.model.get_new_doc('Service Request');\n            doc.customer = frm.doc.customer_name;\n            doc.dep_emp_name = frm.doc.name;\n            doc.employee_type = frm.doc.employee_type;\n            doc.uid_no = frm.doc.uid_no;\n            doc.department_no = this.buildDepartmentNumber(frm);\n            frappe.set_route('Form', doc.doctype, doc.name);\n        });\n    },\n});\n\nfrappe.ui.form.on('Customer Employee Registration', {\n    refresh(frm) {\n        service_workorder.employee_actions.ensureMakeMethods(frm);\n\n        if (frm.is_new()) {\n            return;\n        }\n\n        frm.page.remove_inner_button(__('Create Service Request'), __('Create'));\n        frm.add_custom_button(__('Create Service Request'), () => {\n            service_workorder.employee_actions.createServiceRequest(frm);\n        }, __('Create'));\n    },\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Order",
  "enabled": 1,
  "modified": "2024-06-01 00:00:00.000000",
  "module": "Ag Docs",
  "name": "sales_order_service_charge",
  "script": "// Deprecated",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Invoice",
  "enabled": 1,
  "modified": "2024-06-01 00:00:00.000000",
  "module": "Ag Docs",
  "name": "sales_invoice_service_charge",
  "script": "(function() {\n    var DOC = 'Sales Invoice';\n    var CHILD = 'Sales Invoice Item';\n    var DOC_TOTAL_FIELD = 'custom_total_with_service_charge';\n    var ITEM_TOTAL_FIELD = 'custom_total_with_service_charge';\n    var ITEM_SC_FIELD = 'custom_service_charge';\n    var SLAB_FIELD = 'custom_service_charge_slab';\n    var scheduleTaxRefresh = frappe.utils.debounce(function(frm) {\n        frm.trigger('calculate_taxes_and_totals');\n    }, 200);\n\n    frappe.ui.form.on(DOC, {\n        refresh: function(frm) {\n            frm.set_df_property('custom_total_with_service_charge', 'read_only', 1);\n            recalcAllRows(frm);\n        },\n        customer: function(frm) {\n            loadServiceChargeSlab(frm);\n        },\n        items_add: function(frm, cdt, cdn) {\n            applyServiceCharge(frm, cdt, cdn);\n        },\n        items_remove: function(frm) {\n            computeTotals(frm);\n        }\n    });\n\n    frappe.ui.form.on(CHILD, {\n        item_code: function(frm, cdt, cdn) {\n            applyServiceCharge(frm, cdt, cdn);\n        },\n        qty: function(frm, cdt, cdn) {\n            recalcRow(frm, cdt, cdn);\n        },\n        rate: function(frm, cdt, cdn) {\n            recalcRow(frm, cdt, cdn);\n        },\n        custom_service_charge: function(frm, cdt, cdn) {\n            recalcRow(frm, cdt, cdn);\n        }\n    });\n\n    function loadServiceChargeSlab(frm) {\n        if (!frm.doc.customer) {\n            frm.set_value(SLAB_FIELD, '');\n            computeTotals(frm);\n            return;\n        }\n        frappe.db.get_value('Customer Service Charge Link', {\n            customer: frm.doc.customer,\n            enabled: 1\n        }, 'service_charge_slab', function(r) {\n            var slab = getValue(r, 'service_charge_slab');\n            frm.set_value(SLAB_FIELD, slab || '');\n            (frm.doc.items || []).forEach(function(row) {\n                applyServiceChargeToRow(frm, row);\n            });\n        });\n    }\n\n    function applyServiceCharge(frm, cdt, cdn) {\n        var row = locals[cdt][cdn];\n        if (row) {\n            applyServiceChargeToRow(frm, row);\n        }\n    }\n\n    function applyServiceChargeToRow(frm, row) {\n        if (!row.item_code) {\n            return;\n        }\n        var slab = frm.doc[SLAB_FIELD];\n        if (!slab) {\n            frappe.model.set_value(row.doctype, row.name, ITEM_SC_FIELD, 0);\n            recalcRow(frm, row.doctype, row.name);\n            return;\n        }\n        frappe.call({\n            method: 'service_workorder.api.get_service_charge_from_slab',\n            args: { slab_name: slab, item_code: row.item_code },\n            callback: function(r) {\n                var amount = 0;\n                if (r && r.message && typeof r.message.service_charge !== 'undefined') {\n                    amount = flt(r.message.service_charge);\n                }\n                frappe.model.set_value(row.doctype, row.name, ITEM_SC_FIELD, amount);\n                recalcRow(frm, row.doctype, row.name);\n            }\n        });\n    }\n\n    function recalcAllRows(frm) {\n        (frm.doc.items || []).forEach(function(row) {\n            recalcRow(frm, row.doctype, row.name);\n        });\n    }\n\n    function recalcRow(frm, cdt, cdn) {\n        var row = locals[cdt][cdn];\n        if (!row) {\n            return;\n        }\n        var qty = flt(row.qty) || 0;\n        var rate = flt(row.rate) || 0;\n        var serviceCharge = flt(row[ITEM_SC_FIELD]) || 0;\n        var totalWithService = (qty * rate) + (qty * serviceCharge);\n        frappe.model.set_value(cdt, cdn, ITEM_TOTAL_FIELD, totalWithService);\n        computeTotals(frm);\n    }\n\n    function computeTotals(frm) {\n        var totalWithService = 0;\n        var totalServiceCharge = 0;\n        (frm.doc.items || []).forEach(function(row) {\n            totalWithService += flt(row[ITEM_TOTAL_FIELD]) || 0;\n            totalServiceCharge += (flt(row[ITEM_SC_FIELD]) || 0) * (flt(row.qty) || 0);\n        });\n        frm.set_value(DOC_TOTAL_FIELD, totalWithService);\n        syncServiceChargeTax(frm, totalServiceCharge);\n    }\n\n    function syncServiceChargeTax(frm, amount) {\n        var taxRow = getActualTaxRow(frm);\n        if (!taxRow) {\n            return;\n        }\n        var conversionRate = flt(frm.doc.conversion_rate || 1);\n        var baseAmount = flt(amount) * conversionRate;\n        frappe.model.set_value(taxRow.doctype, taxRow.name, 'tax_amount', amount);\n        frappe.model.set_value(taxRow.doctype, taxRow.name, 'base_tax_amount', baseAmount);\n        frappe.model.set_value(taxRow.doctype, taxRow.name, 'tax_amount_after_discount_amount', amount);\n        frappe.model.set_value(taxRow.doctype, taxRow.name, 'base_tax_amount_after_discount_amount', baseAmount);\n        frm.refresh_field('taxes');\n        scheduleTaxRefresh(frm);\n    }\n\n    function getActualTaxRow(frm) {\n        var taxes = frm.doc.taxes || [];\n        for (var i = 0; i < taxes.length; i++) {\n            var chargeType = taxes[i].charge_type || '';\n            if (chargeType.toLowerCase() === 'actual') {\n                return taxes[i];\n            }\n        }\n        return null;\n    }\n\n    function getValue(response, fieldname) {\n        if (!response) {\n            return '';\n        }\n        if (typeof response[fieldname] !== 'undefined') {\n            return response[fieldname];\n        }\n        if (response.message && typeof response.message[fieldname] !== 'undefined') {\n            return response.message[fieldname];\n        }\n        return '';\n    }\n})();",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Customer Employee Registration",
  "enabled": 1,
  "modified": "2025-12-13 08:00:00.000000",
  "module": "Ag Docs",
  "name": "cer_place_of_issue_reset",
  "script": "frappe.ui.form.on('Customer Employee Registration', {\n    refresh(frm) {\n        ensure_blank_place_of_issue(frm);\n    },\n    document_details_add(frm, cdt, cdn) {\n        ensure_blank_place_of_issue(frm, cdt, cdn);\n    }\n});\n\nfrappe.ui.form.on('Document Detail', {\n    place_of_issue(frm, cdt, cdn) {\n        const row = frappe.get_doc(cdt, cdn);\n        if (row) {\n            row.__manual_place_of_issue = Boolean(row.place_of_issue);\n        }\n    }\n});\n\nfunction ensure_blank_place_of_issue(frm, cdt, cdn) {\n    clear_place_of_issue_default(frm);\n    const targets = cdt && cdn ? [frappe.get_doc(cdt, cdn)].filter(Boolean) : (frm.doc.document_details || []);\n    targets.forEach((row) => {\n        if (!row || row.__manual_place_of_issue || !row.__islocal) {\n            return;\n        }\n        if (row.place_of_issue) {\n            frappe.model.set_value(row.doctype, row.name, 'place_of_issue', '');\n        }\n    });\n}\n\nfunction clear_place_of_issue_default(frm) {\n    const grid = frm.fields_dict.document_details?.grid;\n    if (!grid) {\n        return;\n    }\n    const placeField = grid.fields_map?.place_of_issue;\n    if (placeField && placeField.default) {\n        placeField.default = '';\n    }\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Service Request",
  "enabled": 1,
  "modified": "2025-11-15 13:49:12.878351",
  "module": "Ag Docs",
  "name": "collapse",
  "script": "frappe.ui.form.on(\"Service Request\", {\n    refresh(frm) {\n        // Replace 'no_label' with your actual Section Break fieldname\n        let section = frm.fields_dict.section_details;\n        if (section && section.collapse) {\n            // Force collapse regardless of data\n            section.collapse(true);\n        }\n        \n        \n    }\n    \n});\n\nfrappe.ui.form.on(\"Service Request\", {\n    refresh(frm) {\n        // Replace 'no_label' with your actual Section Break fieldname\n        let section = frm.fields_dict.price_list_and_slab;\n        if (section && section.collapse) {\n            // Force collapse regardless of data\n            section.collapse(true);\n        }\n        \n        \n    }\n    \n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Service Charge Slab",
  "enabled": 1,
  "modified": "2025-11-11 11:39:27.003978",
  "module": "Ag Docs",
  "name": "duplicate_item_check",
  "script": "frappe.ui.form.on(\"Service Charge Slab\", {\n    refresh(frm) {\n        // Perform an initial duplicate check\n        check_duplicate_items(frm);\n    },\n\n    validate: async function(frm) {\n        // 1\ufe0f\u20e3 Check for duplicate items before saving\n        const duplicates = find_duplicate_items(frm);\n        if (duplicates.length > 0) {\n            frappe.throw(\n                __(\"\u26a0\ufe0f Duplicate Item(s) found: {0}. Please remove them before saving.\", \n                    [duplicates.join(\", \")])\n            );\n        }\n\n        // 2\ufe0f\u20e3 Check for duplicate Slab Name (fixed filters)\n        if (frm.doc.slab_name) {\n            const existing = await frappe.db.get_list(\"Service Charge Slab\", {\n                filters: [\n                    [\"slab_name\", \"=\", frm.doc.slab_name],\n                    [\"name\", \"!=\", frm.doc.name]\n                ],\n                limit: 1\n            });\n\n            if (existing.length > 0) {\n                frappe.throw(\n                    __(\"\u26a0\ufe0f Slab Name '{0}' already exists. Please choose another name.\", \n                        [frm.doc.slab_name])\n                );\n            }\n        }\n    }\n});\n\nfrappe.ui.form.on(\"Service Charge Slab Item\", {\n    item(frm, cdt, cdn) {\n        check_duplicate_items(frm);\n    },\n    table_fxxp_add(frm, cdt, cdn) {\n        check_duplicate_items(frm);\n    },\n});\n\nfunction find_duplicate_items(frm) {\n    const seen = new Set();\n    const duplicates = new Set();\n\n    (frm.doc.table_fxxp || []).forEach(r => {\n        if (r.item) {\n            if (seen.has(r.item)) duplicates.add(r.item);\n            seen.add(r.item);\n        }\n    });\n    return Array.from(duplicates);\n}\n\nfunction check_duplicate_items(frm) {\n    if (!frm.fields_dict.table_fxxp) return;\n\n    const duplicates = find_duplicate_items(frm);\n    const grid = frm.fields_dict.table_fxxp.grid;\n\n    grid.grid_rows.forEach(gr => {\n        const row = gr.doc;\n        if (duplicates.includes(row.item)) {\n            $(gr.wrapper).addClass('duplicate-row');\n        } else {\n            $(gr.wrapper).removeClass('duplicate-row');\n        }\n    });\n\n    let warning_area = $(frm.fields_dict.table_fxxp.wrapper).find(\".duplicate-warning\");\n    if (warning_area.length === 0) {\n        warning_area = $('<div class=\"duplicate-warning\" style=\"margin-top:6px;font-size:12px;color:#b30000;\"></div>')\n            .appendTo(frm.fields_dict.table_fxxp.wrapper);\n    }\n\n    if (duplicates.length > 0) {\n        warning_area.html(`\u26a0\ufe0f Duplicate item(s) detected: <b>${duplicates.join(\", \")}</b>`);\n    } else {\n        warning_area.html(\"\");\n    }\n}\n\nfrappe.ui.form.on(\"Service Charge Slab\", \"onload\", function(frm) {\n    frappe.dom.add_stylesheet(`\n        .grid-body .rows .duplicate-row {\n            background-color: #ffe6e6 !important;\n        }\n    `);\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Customer Service Charge Link",
  "enabled": 1,
  "modified": "2025-11-10 19:45:48.552144",
  "module": "Ag Docs",
  "name": "duplicate_cust_check_link",
  "script": "frappe.ui.form.on(\"Customer Service Charge Link\", {\n    // \u2705 New live helper text\n    customer(frm) {\n        if (!frm.doc.customer) return;\n\n        frappe.db.get_value(\n            \"Customer Service Charge Link\",\n            { customer: frm.doc.customer, enabled: 1 },\n            [\"service_charge_slab\"]\n        ).then(r => {\n            if (r && r.message && r.message.service_charge_slab) {\n                frm.set_df_property(\n                    \"customer\",\n                    \"description\",\n                    __(\"\u2705 Existing Slab: {0}\", [r.message.service_charge_slab])\n                );\n            } else {\n                frm.set_df_property(\n                    \"customer\",\n                    \"description\",\n                    __(\"\u26a0\ufe0f No Service Charge Slab linked yet.\")\n                );\n            }\n            frm.refresh_field(\"customer\");\n        });\n    },\n\n    refresh(frm) {\n        frm.set_df_property(\"customer\", \"description\", \"\");\n    },\n\n    // \u2705 Keep your duplicate check section here\n    validate(frm) {\n        if (frm.doc.customer && frm.doc.service_charge_slab) {\n            frappe.call({\n                method: \"frappe.client.get_list\",\n                args: {\n                    doctype: \"Customer Service Charge Link\",\n                    filters: {\n                        customer: frm.doc.customer,\n                        service_charge_slab: frm.doc.service_charge_slab,\n                        name: [\"!=\", frm.doc.name]\n                    },\n                    fields: [\"name\"]\n                },\n                async: false,\n                callback: function (r) {\n                    if (r.message && r.message.length > 0) {\n                        frappe.throw(\n                            __(\"\u26a0\ufe0f Duplicate combination found: This Service Charge Slab is already linked for the selected Customer.\")\n                        );\n                    }\n                }\n            });\n        }\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Service Request",
  "enabled": 0,
  "modified": "2025-11-13 12:08:50.057234",
  "module": "Ag Docs",
  "name": "gov_charge_load",
  "script": "// =============================\n// SERVICE REQUEST CLIENT SCRIPT\n// =============================\n\n// 1\ufe0f\u20e3 When Customer is selected \u2192 Load Price List\nfrappe.ui.form.on('Service Request', {\n    customer: async function(frm) {\n        if (!frm.doc.customer) return;\n\n        // Fetch default price list for this customer\n        let price_list = await frappe.db.get_value(\n            \"Customer\",\n            frm.doc.customer,\n            \"default_price_list\"\n        );\n\n        if (price_list && price_list.message && price_list.message.default_price_list) {\n            frm.set_value(\"price_list\", price_list.message.default_price_list);\n        } else {\n            frm.set_value(\"price_list\", \"\");\n        }\n        frm.refresh_field(\"price_list\");\n    }\n});\n\nfrappe.ui.form.on('Service Request', {\n    price_list: function(frm) {\n        frm.doc.work_details.forEach(row => {\n            frappe.model.set_value(row.doctype, row.name, 'item_code', row.item_code);\n        });\n    }\n});\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Service Request",
  "enabled": 0,
  "modified": "2025-11-13 12:08:56.438733",
  "module": "Ag Docs",
  "name": "gov_charge_load 01",
  "script": "// =============================\n// SERVICE REQUEST ITEM SCRIPT\n// =============================\n\nfrappe.ui.form.on('Service Request Item', {\n    item_code: async function(frm, cdt, cdn) {\n        let row = frappe.get_doc(cdt, cdn);\n        if (!row.item_code || !frm.doc.price_list) return;\n\n        // Fetch rate from Item Price based on Price List\n        let price_data = await frappe.db.get_value(\"Item Price\", {\n            item_code: row.item_code,\n            price_list: frm.doc.price_list\n        }, [\"price_list_rate\"]);\n\n        if (price_data && price_data.message && price_data.message.price_list_rate) {\n            frappe.model.set_value(cdt, cdn, \"gov_charge\", price_data.message.price_list_rate);\n        } else {\n            frappe.model.set_value(cdt, cdn, \"gov_charge\", 0);\n        }\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Customer Employee Registration",
  "enabled": 1,
  "modified": "2025-11-11 09:54:21.207044",
  "module": "Ag Docs",
  "name": "unique_check",
  "script": "frappe.ui.form.on('Customer Employee Registration', {\n    uid_no: function(frm) {\n        check_duplicate_inline(frm, 'uid_no');\n    },\n    passport_no: function(frm) {\n        check_duplicate_inline(frm, 'passport_no');\n    },\n    eid_no: function(frm) {\n        check_duplicate_inline(frm, 'eid_no');\n    }\n});\n\nasync function check_duplicate_inline(frm, fieldname) {\n    const value = frm.doc[fieldname];\n    if (!value) {\n        clear_inline_error(frm, fieldname);\n        return;\n    }\n\n    try {\n        const existing = await frappe.db.get_list('Customer Employee Registration', {\n            filters: [[fieldname, '=', value], ['name', '!=', frm.doc.name]],\n            limit: 1\n        });\n\n        const field = frm.fields_dict[fieldname];\n        const label = frappe.meta.get_label(frm.doc.doctype, fieldname);\n\n        if (existing.length > 0) {\n            // show inline red warning under the field\n            field.$wrapper.css(\"position\", \"relative\");\n            if (!field.$wrapper.find('.dup-warning').length) {\n                field.$wrapper.append(\n                    `<div class=\"dup-warning\" style=\"color:red; font-size:12px; margin-top:2px;\">\n                        ${label} already exists!\n                    </div>`\n                );\n            }\n        } else {\n            clear_inline_error(frm, fieldname);\n        }\n    } catch (e) {\n        console.error(e);\n    }\n}\n\nfunction clear_inline_error(frm, fieldname) {\n    frm.fields_dict[fieldname].$wrapper.find('.dup-warning').remove();\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Service Request",
  "enabled": 1,
  "modified": "2025-11-15 13:48:37.423811",
  "module": "Ag Docs",
  "name": "tax_and_cat",
  "script": "frappe.provide(\"service_workorder.sr\");\n\nconst serviceRequestController = {\n    priceListCache: {},\n    slabCache: {},\n    govChargeCache: {},\n    serviceChargeCache: {},\n\n    async initialize(frm) {\n        await this.ensureDefaults(frm);\n    },\n\n    async ensureDefaults(frm) {\n        if (!frm.doc.customer || !frm.doc.company) {\n            return;\n        }\n        await Promise.all([\n            this.setPriceList(frm),\n            this.setServiceChargeSlab(frm),\n            this.setTaxCategoryAndTemplate(frm),\n        ]);\n    },\n\n    async handleCustomerOrCompanyChange(frm) {\n        await this.ensureDefaults(frm);\n        await this.refreshAllRows(frm);\n        this.updateTotals(frm);\n    },\n\n    getDefaultRowDate(frm) {\n        return frm.doc.date || frappe.datetime.get_today();\n    },\n\n    ensureCustomerSelected(frm) {\n        if (frm.doc.customer) {\n            return true;\n        }\n        frappe.msgprint(__('Please select a Customer before adding items.'));\n        return false;\n    },\n\n    clearRowItem(frm, cdt, cdn) {\n        frm.__skip_item_code_guard = true;\n        frappe.model.set_value(cdt, cdn, 'item_code', '');\n    },\n\n    markManualItemChange(frm) {\n        if (frm.__job_bundle_loading || !frm.doc.job_item) {\n            return;\n        }\n        frm.set_value('job_item', null);\n    },\n\n    async loadProductBundle(frm) {\n        if (!frm.doc.job_item) {\n            return;\n        }\n\n        if (!this.ensureCustomerSelected(frm)) {\n            frm.set_value('job_item', null);\n            return;\n        }\n\n        const { message } = await frappe.call({\n            method: 'service_workorder.api.get_product_bundle_items',\n            args: { product_bundle: frm.doc.job_item },\n        });\n\n        const bundleItems = message || [];\n        if (!bundleItems.length) {\n            frappe.msgprint(__('Selected Job has no items to load.'));\n            return;\n        }\n\n        frm.__job_bundle_loading = true;\n        try {\n            frm.clear_table('work_details');\n            bundleItems.forEach((bundleRow) => {\n                const row = frm.add_child('work_details');\n                row.item_code = bundleRow.item_code;\n                row.item_name = bundleRow.item_name || '';\n                row.qty = bundleRow.qty || 1;\n                row.status = row.status || 'Pending';\n                row.item_date = this.getDefaultRowDate(frm);\n            });\n            frm.refresh_field('work_details');\n\n            for (const row of frm.doc.work_details || []) {\n                await this.applyChargesForRow(frm, row);\n            }\n            this.updateTotals(frm);\n        } finally {\n            frm.__job_bundle_loading = false;\n        }\n    },\n\n    async setPriceList(frm) {\n        if (!frm.doc.customer) return;\n        const key = `${frm.doc.customer}::${frm.doc.company || ''}`;\n        if (!(key in this.priceListCache)) {\n            let priceList = '';\n            const customer = await frappe.db.get_value('Customer', frm.doc.customer, 'default_price_list');\n            priceList = customer?.message?.default_price_list || '';\n            if (!priceList && frm.doc.company) {\n                const company = await frappe.db.get_value('Company', frm.doc.company, 'default_price_list');\n                priceList = company?.message?.default_price_list || '';\n            }\n            this.priceListCache[key] = priceList || 'Standard Selling';\n        }\n        if (frm.doc.price_list !== this.priceListCache[key]) {\n            await frm.set_value('price_list', this.priceListCache[key]);\n        }\n    },\n\n    async setServiceChargeSlab(frm) {\n        if (!frm.doc.customer) return;\n        const key = `${frm.doc.customer}::${frm.doc.company || ''}`;\n        if (!(key in this.slabCache)) {\n            const response = await frappe.db.get_value('Customer Service Charge Link', {\n                customer: frm.doc.customer,\n                company: frm.doc.company,\n                enabled: 1,\n            }, 'service_charge_slab');\n            this.slabCache[key] = response?.message?.service_charge_slab || '';\n        }\n        if (frm.doc.service_charge_slab !== this.slabCache[key]) {\n            await frm.set_value('service_charge_slab', this.slabCache[key]);\n        }\n    },\n\n    async setTaxCategoryAndTemplate(frm) {\n        if (!frm.doc.customer || !frm.doc.company) return;\n        const { message } = await frappe.db.get_value('Customer', frm.doc.customer, 'tax_category');\n        const taxCategory = message?.tax_category || '';\n        if (taxCategory && frm.doc.tax_category !== taxCategory) {\n            await frm.set_value('tax_category', taxCategory);\n        }\n        if (taxCategory) {\n            const templateResponse = await frappe.call({\n                method: 'service_workorder.api.get_sales_tax_template',\n                args: {\n                    company: frm.doc.company,\n                    tax_category: taxCategory,\n                },\n            });\n            const template = templateResponse?.message || '';\n            if (template && frm.doc.sales_taxes_and_charges_template !== template) {\n                await frm.set_value('sales_taxes_and_charges_template', template);\n            }\n        }\n    },\n\n    async loadTaxTemplate(frm) {\n        if (!frm.doc.sales_taxes_and_charges_template) return;\n        const response = await frappe.call({\n            method: 'service_workorder.api.load_sales_taxes',\n            args: { template_name: frm.doc.sales_taxes_and_charges_template },\n        });\n        frm.clear_table('taxes');\n        (response.message || []).forEach((tax) => {\n            const row = frm.add_child('taxes');\n            row.charge_type = tax.charge_type;\n            row.account_head = tax.account_head;\n            row.rate = tax.rate;\n            row.description = tax.description;\n        });\n        frm.refresh_field('taxes');\n        this.updateTotals(frm);\n    },\n\n    async refreshAllRows(frm) {\n        const rows = frm.doc.work_details || [];\n        for (const row of rows) {\n            await this.applyChargesForRow(frm, row);\n        }\n    },\n\n    async applyChargesForRow(frm, row) {\n        if (!row.item_code) return;\n        const govCharge = await this.getGovCharge(row.item_code, frm.doc.price_list);\n        const serviceCharge = await this.getServiceCharge(frm.doc.service_charge_slab, row.item_code);\n        frappe.model.set_value(row.doctype, row.name, 'gov_charge', govCharge);\n        frappe.model.set_value(row.doctype, row.name, 'service_charge', serviceCharge);\n        await this.setItemDetails(frm, row);\n        this.updateRowAmount(row);\n    },\n\n    async getGovCharge(itemCode, priceList) {\n        if (!itemCode || !priceList) return 0;\n        const key = `${itemCode}::${priceList}`;\n        if (!(key in this.govChargeCache)) {\n            let value = await this.fetchItemPrice(itemCode, priceList);\n            if (!value && priceList !== 'Standard Selling') {\n                value = await this.fetchItemPrice(itemCode, 'Standard Selling');\n            }\n            this.govChargeCache[key] = flt(value || 0);\n        }\n        return this.govChargeCache[key];\n    },\n\n    async fetchItemPrice(itemCode, priceList) {\n        const result = await frappe.db.get_value('Item Price', { item_code: itemCode, price_list: priceList }, 'price_list_rate');\n        return result?.message?.price_list_rate || 0;\n    },\n\n    async getServiceCharge(slabName, itemCode) {\n        if (!slabName || !itemCode) return 0;\n        const key = `${slabName}::${itemCode}`;\n        if (!(key in this.serviceChargeCache)) {\n            const response = await frappe.call({\n                method: 'service_workorder.api.get_service_charge_from_slab',\n                args: { slab_name: slabName, item_code: itemCode },\n            });\n            this.serviceChargeCache[key] = flt(response?.message?.service_charge || 0);\n        }\n        return this.serviceChargeCache[key];\n    },\n\n    async setItemDetails(frm, row) {\n        if (!row.item_code) return;\n        const itemResponse = await frappe.db.get_value('Item', row.item_code, 'item_group');\n        const itemGroup = itemResponse?.message?.item_group || '';\n        frappe.model.set_value(row.doctype, row.name, 'item_group', itemGroup);\n        if (!row.item_date) {\n            frappe.model.set_value(row.doctype, row.name, 'item_date', this.getDefaultRowDate(frm));\n        }\n    },\n\n    updateRowAmount(row) {\n        const qty = flt(row.qty) || 0;\n        const gov = flt(row.gov_charge) || 0;\n        const service = flt(row.service_charge) || 0;\n        const amount = qty * (gov + service);\n        frappe.model.set_value(row.doctype, row.name, 'amount', amount);\n    },\n\n    async warnOnEmployeeCompletion(frm) {\n        if (!frm.doc.dep_emp_name) {\n            return;\n        }\n        const completedCount = (frm.doc.work_details || []).filter((row) => row.status === 'Completed').length;\n        if (!completedCount) {\n            return;\n        }\n        const response = await frappe.call({\n            method: 'service_workorder.api.check_employee_completion_warning',\n            args: {\n                employee: frm.doc.dep_emp_name,\n                service_request: frm.doc.name || '',\n                completed_in_doc: completedCount,\n            },\n        });\n        const warning = response?.message?.warning;\n        if (warning) {\n            frappe.msgprint({\n                title: __('Completion Warning'),\n                indicator: 'orange',\n                message: warning,\n            });\n        }\n    },\n\n    updateTotals(frm) {\n        let govTotal = 0;\n        let serviceTotal = 0;\n        let baseTotal = 0;\n\n        (frm.doc.work_details || []).forEach((row) => {\n            const qty = flt(row.qty) || 0;\n            const gov = flt(row.gov_charge) || 0;\n            const service = flt(row.service_charge) || 0;\n            govTotal += gov * qty;\n            serviceTotal += service * qty;\n            baseTotal += (gov + service) * qty;\n        });\n\n        const taxes = frm.doc.taxes || [];\n        if (!taxes.length) return;\n\n        const serviceRow = taxes[0];\n        frappe.model.set_value(serviceRow.doctype, serviceRow.name, 'tax_amount', serviceTotal);\n        frappe.model.set_value(serviceRow.doctype, serviceRow.name, 'total', baseTotal);\n\n        if (taxes.length > 1) {\n            const vatRow = taxes[1];\n            const vatAmount = (serviceTotal * flt(vatRow.rate || 0)) / 100;\n            frappe.model.set_value(vatRow.doctype, vatRow.name, 'tax_amount', vatAmount);\n            frappe.model.set_value(vatRow.doctype, vatRow.name, 'total', baseTotal + vatAmount);\n        }\n\n        frm.refresh_field('taxes');\n    },\n};\n\nfrappe.ui.form.on('Service Request', {\n    async onload(frm) {\n        await serviceRequestController.initialize(frm);\n    },\n    async refresh(frm) {\n        frm.set_query('item_code', 'work_details', () => ({\n            filters: { is_sales_item: 1 },\n        }));\n        await serviceRequestController.ensureDefaults(frm);\n        serviceRequestController.updateTotals(frm);\n    },\n    async customer(frm) {\n        await serviceRequestController.handleCustomerOrCompanyChange(frm);\n    },\n    async company(frm) {\n        await serviceRequestController.handleCustomerOrCompanyChange(frm);\n    },\n    async sales_taxes_and_charges_template(frm) {\n        await serviceRequestController.loadTaxTemplate(frm);\n    },\n    async job_item(frm) {\n        if (frm.doc.job_item) {\n            if (!serviceRequestController.ensureCustomerSelected(frm)) {\n                frm.set_value('job_item', null);\n                return;\n            }\n            await serviceRequestController.loadProductBundle(frm);\n        }\n    },\n});\n\nfrappe.ui.form.on('Service Request Item', {\n    async item_code(frm, cdt, cdn) {\n        if (frm.__skip_item_code_guard) {\n            frm.__skip_item_code_guard = false;\n            return;\n        }\n        serviceRequestController.markManualItemChange(frm);\n        if (!serviceRequestController.ensureCustomerSelected(frm)) {\n            serviceRequestController.clearRowItem(frm, cdt, cdn);\n            return;\n        }\n        const row = frappe.get_doc(cdt, cdn);\n        await serviceRequestController.applyChargesForRow(frm, row);\n        serviceRequestController.updateTotals(frm);\n    },\n    qty(frm, cdt, cdn) {\n        serviceRequestController.markManualItemChange(frm);\n        const row = frappe.get_doc(cdt, cdn);\n        serviceRequestController.updateRowAmount(row);\n        serviceRequestController.updateTotals(frm);\n    },\n    gov_charge(frm, cdt, cdn) {\n        serviceRequestController.markManualItemChange(frm);\n        const row = frappe.get_doc(cdt, cdn);\n        serviceRequestController.updateRowAmount(row);\n        serviceRequestController.updateTotals(frm);\n    },\n    service_charge(frm, cdt, cdn) {\n        serviceRequestController.markManualItemChange(frm);\n        const row = frappe.get_doc(cdt, cdn);\n        serviceRequestController.updateRowAmount(row);\n        serviceRequestController.updateTotals(frm);\n    },\n    status(frm, cdt, cdn) {\n        serviceRequestController.markManualItemChange(frm);\n        const today = frappe.datetime.get_today();\n        frappe.model.set_value(cdt, cdn, 'item_date', today);\n        const row = frappe.get_doc(cdt, cdn);\n        if (row.status === 'Completed') {\n            serviceRequestController.warnOnEmployeeCompletion(frm);\n        }\n    },\n    work_details_add(frm, cdt, cdn) {\n        serviceRequestController.markManualItemChange(frm);\n        frappe.model.set_value(cdt, cdn, 'item_date', serviceRequestController.getDefaultRowDate(frm));\n    },\n    work_details_remove(frm) {\n        serviceRequestController.markManualItemChange(frm);\n        serviceRequestController.updateTotals(frm);\n    },\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Service Request",
  "enabled": 0,
  "modified": "2025-11-15 13:48:59.370795",
  "module": "Ag Docs",
  "name": "slab_priclist",
  "script": "// =======================================================\n// SERVICE REQUEST \u2013 PRICE LIST + GOV CHARGE + SLAB + SERVICE CHARGE\n// =======================================================\n\n// -----------------------------\n// 1\ufe0f\u20e3 LOAD PRICE LIST\n// -----------------------------\nasync function load_price_list(frm) {\n    if (!frm.doc.customer || !frm.doc.company) return;\n\n    // Get Customer Default Price List\n    const cust = await frappe.db.get_value(\n        \"Customer\",\n        frm.doc.customer,\n        \"default_price_list\"\n    );\n\n    let price_list = cust?.message?.default_price_list || \"\";\n\n    // If Customer has no price list \u2192 use Company default\n    if (!price_list) {\n        const comp = await frappe.db.get_value(\n            \"Company\",\n            frm.doc.company,\n            \"default_price_list\"\n        );\n        price_list = comp?.message?.default_price_list || \"\";\n    }\n\n    frm.set_value(\"price_list\", price_list);\n}\n\n\n\n// -----------------------------\n// 2\ufe0f\u20e3 LOAD GOV CHARGE (ITEM PRICE LIST RATE)\n// -----------------------------\nasync function load_gov_charge(frm, cdt, cdn) {\n    let row = frappe.get_doc(cdt, cdn);\n\n    if (!row.item_code || !frm.doc.price_list) return;\n\n    const result = await frappe.call({\n        method: \"frappe.client.get_list\",\n        args: {\n            doctype: \"Item Price\",\n            filters: {\n                item_code: row.item_code,\n                price_list: frm.doc.price_list\n            },\n            fields: [\"price_list_rate\"],\n            limit_page_length: 1\n        }\n    });\n\n    let rate = result.message?.[0]?.price_list_rate || 0;\n    frappe.model.set_value(cdt, cdn, \"gov_charge\", rate);\n}\n\n\n\n// -----------------------------\n// 3\ufe0f\u20e3 LOAD SLAB FROM CUSTOMER SERVICE CHARGE LINK (FIXED)\n// -----------------------------\nasync function load_slab(frm) {\n    if (!frm.doc.customer) return;\n\n    const res = await frappe.db.get_value(\n        \"Customer Service Charge Link\",\n        { customer: frm.doc.customer, enabled: 1 },\n        [\"service_charge_slab\"]   // ONLY THIS FIELD EXISTS\n    );\n\n    frm.set_value(\"service_charge_slab\", res?.message?.service_charge_slab || \"\");\n}\n\n\n\n// -----------------------------\n// 4\ufe0f\u20e3 LOAD SERVICE CHARGE PER ITEM (FROM SLAB)\n// -----------------------------\nasync function load_service_charge(frm, cdt, cdn) {\n    let row = frappe.get_doc(cdt, cdn);\n    let slab = frm.doc.service_charge_slab;\n\n    if (!slab || !row.item_code) {\n        frappe.model.set_value(cdt, cdn, \"service_charge\", 0);\n        return;\n    }\n\n    const result = await frappe.call({\n        method: \"service_workorder.api.get_service_charge_from_slab\",\n        args: {\n            slab_name: slab,\n            item_code: row.item_code\n        }\n    });\n\n    let sc = result.message?.service_charge || 0;\n    frappe.model.set_value(cdt, cdn, \"service_charge\", sc);\n}\n\n\n\n// =======================================================\n// \ud83d\udd04 HOOK EVENTS\n// =======================================================\n\nfrappe.ui.form.on(\"Service Request\", {\n    // When customer selected \u2192 load price list & slab\n    async customer(frm) {\n        await load_price_list(frm);\n        await load_slab(frm);\n    }\n});\n\nfrappe.ui.form.on(\"Service Request Item\", {\n    async item_code(frm, cdt, cdn) {\n        await load_price_list(frm);             // reload price list\n        await load_gov_charge(frm, cdt, cdn);   // load gov charge\n        await load_service_charge(frm, cdt, cdn); // load slab service charge\n    }\n});\n\n\n// =======================================================\n// 5\ufe0f\u20e3 CALCULATE TOTAL GOV CHARGE + SERVICE CHARGE\n// =======================================================\n\nfunction update_tax_totals(frm) {\n    let total_gov = 0;\n    let total_service = 0;\n\n    // Calculate totals from Work Details table\n    (frm.doc.work_details || []).forEach(row => {\n        let qty = flt(row.qty);\n        let gov = flt(row.gov_charge);\n        let sc = flt(row.service_charge);\n\n        total_gov += gov * qty;\n        total_service += sc * qty;\n    });\n\n    if (!frm.doc.taxes || frm.doc.taxes.length === 0) return;\n\n    let tax = frm.doc.taxes[0];\n\n    // FIX: Amount = service charge total\n    tax.tax_amount = total_service;\n\n    // FIX: Total = gov total + service total\n    tax.total = total_gov + total_service;\n\n    frm.refresh_field(\"taxes\");\n}\n\n\n\n// =======================================================\n// 6\ufe0f\u20e3 TRIGGER UPDATE WHEN VALUES CHANGE\n// =======================================================\nfrappe.ui.form.on(\"Service Request Item\", {\n    qty(frm) { update_tax_totals(frm); },\n    gov_charge(frm) { update_tax_totals(frm); },\n    service_charge(frm) { update_tax_totals(frm); },\n    work_details_remove(frm) { update_tax_totals(frm); }\n});\n\nfrappe.ui.form.on(\"Service Request\", {\n    refresh(frm) { update_tax_totals(frm); }\n});\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Service Request",
  "enabled": 1,
  "modified": "2025-11-15 12:46:58.206069",
  "module": "Ag Docs",
  "name": "sales_ord_inv_btn",
  "script": "\nfrappe.provide(\"service_workorder.sr_actions\");\n\nObject.assign(service_workorder.sr_actions, {\n    ensureMakeMethods(frm) {\n        frm.make_methods = frm.make_methods || {};\n        frm.make_methods[\"Sales Order\"] = () => this.createSalesOrder(frm);\n        frm.make_methods[\"Sales Invoice\"] = () => this.createSalesInvoice(frm);\n    },\n\n    guardCreation(frm, target) {\n        if (frm.is_new()) {\n            frappe.msgprint(\"Please save the Service Request before creating linked documents.\");\n            return false;\n        }\n\n        if (frm.doc.sales_order_ref || frm.doc.sales_invoice_ref) {\n            frappe.msgprint(\"This Service Request already has a linked Sales Order or Invoice.\");\n            return false;\n        }\n\n        if (target === \"Sales Order\" && frm.doc.docstatus !== 0) {\n            frappe.msgprint(\"Sales Orders can only be created while the Service Request is in Draft.\");\n            return false;\n        }\n\n        if (target === \"Sales Invoice\" && frm.doc.docstatus !== 1) {\n            frappe.msgprint(\"You can only create a Sales Invoice after the Service Request is submitted.\");\n            return false;\n        }\n\n        return true;\n    },\n\n    createSalesOrder(frm) {\n        if (!this.guardCreation(frm, \"Sales Order\")) {\n            return;\n        }\n\n        frappe.confirm(\"Do you want to create a Sales Order?\", () => {\n            frappe.call({\n                method: \"service_workorder.api.create_sales_order_from_service_request\",\n                args: { service_request: frm.doc.name },\n                freeze: true,\n                freeze_message: \"Creating Sales Order...\",\n                callback: (r) => {\n                    if (!r.message) {\n                        frappe.msgprint(\"Failed to create Sales Order\");\n                        return;\n                    }\n                    const soName = r.message.name;\n                    frappe.msgprint(\"Sales Order Created: \" + soName);\n                    frappe.set_route(\"Form\", \"Sales Order\", soName);\n                },\n            });\n        });\n    },\n\n    createSalesInvoice(frm) {\n        if (!this.guardCreation(frm, \"Sales Invoice\")) {\n            return;\n        }\n\n        frappe.confirm(\"Do you want to create a Sales Invoice?\", () => {\n            frappe.call({\n                method: \"service_workorder.api.create_sales_invoice_from_service_request\",\n                args: { service_request: frm.doc.name },\n                freeze: true,\n                freeze_message: \"Creating Sales Invoice...\",\n                callback: (r) => {\n                    if (!r.message) {\n                        frappe.msgprint(\"Failed to create Sales Invoice\");\n                        return;\n                    }\n                    const siName = r.message.name;\n                    frappe.msgprint(\"Sales Invoice Created: \" + siName);\n                    frappe.set_route(\"Form\", \"Sales Invoice\", siName);\n                },\n            });\n        });\n    },\n});\n\nfrappe.ui.form.on(\"Service Request\", {\n    refresh(frm) {\n        // Remove default ERPNext create buttons and reset ours\n        frm.page.remove_inner_button(\"Sales Order\", \"Create\");\n        frm.page.remove_inner_button(\"Sales Invoice\", \"Create\");\n        frm.page.remove_inner_button(\"Create Sales Order\", \"Create\");\n        frm.page.remove_inner_button(\"Create Sales Invoice\", \"Create\");\n        frm.clear_custom_buttons();\n\n        if (frm.is_new()) {\n            return;\n        }\n\n        service_workorder.sr_actions.ensureMakeMethods(frm);\n\n        frm.add_custom_button(\"Create Sales Order\", () => {\n            service_workorder.sr_actions.createSalesOrder(frm);\n        }, \"Create\");\n\n        frm.add_custom_button(\"Create Sales Invoice\", () => {\n            service_workorder.sr_actions.createSalesInvoice(frm);\n        }, \"Create\");\n    },\n});\n\nfrappe.ui.form.on(\"Service Request\", {\n    before_cancel(frm) {\n        return frappe.call({\n            method: \"service_workorder.api.validate_sr_cancel_or_delete\",\n            args: { sr_name: frm.doc.name },\n        });\n    },\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Customer Employee Registration",
  "enabled": 1,
  "modified": "2025-11-05 09:14:26.427147",
  "module": "Ag Docs",
  "name": "full_name",
  "script": "frappe.ui.form.on('Customer Employee Registration', {\n    first_name: function(frm) {\n        frm.set_value('full_name', (frm.doc.first_name || '') + ' ' + (frm.doc.last_name || ''));\n    },\n    last_name: function(frm) {\n        frm.set_value('full_name', (frm.doc.first_name || '') + ' ' + (frm.doc.last_name || ''));\n    },\n    employee_type: function(frm) {\n        if (frm.doc.employee_type === 'Dependent') {\n            frm.set_df_property('link_employee', 'hidden', 0);\n        } else {\n            frm.set_df_property('link_employee', 'hidden', 1);\n        }\n    },\n    customer: function(frm) {\n        frm.set_query('link_employee', function() {\n            return {\n                filters: {\n                    customer: frm.doc.customer,\n                    employee_type: 'Employee'\n                }\n            };\n        });\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Service Request",
  "enabled": 1,
  "modified": "2025-12-09 17:09:35.469943",
  "module": "Ag Docs",
  "name": "emp_filter",
  "script": "frappe.ui.form.on(\"Service Request\", {\r\n    refresh(frm) {\r\n        frm.set_query(\"dep_emp_name\", () => {\r\n            if (!frm.doc.customer) {\r\n                return { filters: { customer_name: \"Select Customer\" } };\r\n            }\r\n            return { filters: { customer_name: frm.doc.customer, active: 1 } };\r\n        });\r\n\r\n        load_employee_details(frm);\r\n        check_existing_draft(frm);\r\n    },\r\n\r\n    customer(frm) {\r\n        frm.set_value({\r\n            dep_emp_name: null,\r\n            employee_type: null,\r\n            uid_no: null,\r\n            department_no: null\r\n        });\r\n        frm.refresh_fields();\r\n    },\r\n\r\n    dep_emp_name(frm) {\r\n        load_employee_details(frm);\r\n        check_existing_draft(frm);\r\n    }\r\n});\r\n\r\n// -------------------------------------------------------------\r\n// \ud83d\udd25 Auto-load employee details + NEW: Customer Emp Dep ID check\r\n// -------------------------------------------------------------\r\nasync function load_employee_details(frm) {\r\n    if (!frm.doc.dep_emp_name) return;\r\n\r\n    const emp = await frappe.db.get_value(\r\n        \"Customer Employee Registration\",\r\n        frm.doc.dep_emp_name,\r\n        [\"employee_type\", \"dep_no1\", \"dep_no2\", \"uid_no\"]\r\n    );\r\n\r\n    if (!emp || !emp.message) return;\r\n\r\n    // Build department number\r\n    let dep_no = \"\";\r\n    if (emp.message.dep_no1) dep_no = emp.message.dep_no1;\r\n    if (emp.message.dep_no2) {\r\n        dep_no = dep_no ? dep_no + \"/\" + emp.message.dep_no2 : emp.message.dep_no2;\r\n    }\r\n\r\n    // Set values to Service Request\r\n    frm.set_value(\"employee_type\", emp.message.employee_type || \"\");\r\n    frm.set_value(\"department_no\", dep_no || \"\");\r\n    frm.set_value(\"uid_no\", emp.message.uid_no || \"\");\r\n    frm.refresh_fields();\r\n\r\n    // -------------------------------------------------------------\r\n    // \ud83d\udd0d NEW FEATURE: Check Customer \u2192 Emp Dep ID flag\r\n    // -------------------------------------------------------------\r\n    if (frm.doc.customer) {\r\n        const cust = await frappe.db.get_value(\r\n            \"Customer\",\r\n            frm.doc.customer,\r\n            \"custom_emp_dep_id\"\r\n        );\r\n\r\n        const depRequired = cint(cust?.message?.custom_emp_dep_id) === 1;\r\n\r\n        if (depRequired && !emp.message.dep_no1 && !emp.message.dep_no2) {\r\n            frappe.msgprint({\r\n                title: __(\"Warning: Missing Department No\"),\r\n                indicator: \"orange\",\r\n                message: __(\r\n                    \"Please Update The Department Number\"\r\n                )\r\n            });\r\n        }\r\n    }\r\n}\r\n\r\n// -------------------------------------------------------------\r\nasync function check_existing_draft(frm) {\r\n    if (!frm.doc.customer || !frm.doc.dep_emp_name) return;\r\n\r\n    const existing = await frappe.db.get_list(\"Service Request\", {\r\n        filters: {\r\n            customer: frm.doc.customer,\r\n            dep_emp_name: frm.doc.dep_emp_name,\r\n            docstatus: 0\r\n        },\r\n        fields: [\"name\"],\r\n        limit: 1\r\n    });\r\n\r\n    if (existing && existing.length > 0 && existing[0].name !== frm.doc.name) {\r\n        frappe.msgprint({\r\n            title: __(\"Warning\"),\r\n            indicator: \"orange\",\r\n            message: __(\r\n                \"A draft Service Request already exists for this Customer/Employee: <b>{0}</b>\",\r\n                [existing[0].name]\r\n            )\r\n        });\r\n    }\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Customer Employee Registration",
  "enabled": 1,
  "modified": "2025-12-09 17:03:01.012012",
  "module": "Ag Docs",
  "name": "main_emp_filter",
  "script": "frappe.ui.form.on('Customer Employee Registration', {\r\n    async refresh(frm) {\r\n        setup_save_confirmation(frm);\r\n\r\n        frm.set_query('dep_emp_name', () => {\r\n            if (frm.doc.employee_type !== 'Dependent') return {};\r\n\r\n            if (!frm.doc.customer_name) {\r\n                frappe.msgprint(__('Please select a Customer first'));\r\n                return { filters: { name: ['is', 'set'] } };\r\n            }\r\n\r\n            return {\r\n                filters: {\r\n                    customer_name: frm.doc.customer_name,\r\n                    employee_type: 'Employee',\r\n                    active: 1\r\n                }\r\n            };\r\n        });\r\n\r\n        if (frm.is_new()) {\r\n            frm.set_value('nationality', '');\r\n        }\r\n\r\n        await enforce_dep_no_requirement(frm);\r\n        apply_uid_requirement(frm);\r\n    },\r\n\r\n    async customer_name(frm) {\r\n        frm.set_value('dep_emp_name', '');\r\n        frm.set_value('linked_emp_info', '');\r\n        await enforce_dep_no_requirement(frm);\r\n    },\r\n\r\n    employee_type(frm) {\r\n        frm.set_value('dep_emp_name', '');\r\n        frm.set_value('linked_emp_info', '');\r\n    },\r\n\r\n    new_employee(frm) {\r\n        apply_uid_requirement(frm);\r\n    },\r\n\r\n    async dep_emp_name(frm) {\r\n        if (!frm.doc.dep_emp_name) {\r\n            frm.set_value('linked_emp_info', '');\r\n            return;\r\n        }\r\n\r\n        try {\r\n            const emp = await frappe.db.get_doc(\r\n                'Customer Employee Registration',\r\n                frm.doc.dep_emp_name\r\n            );\r\n\r\n            const asText = v => (v === undefined || v === null) ? '' : String(v).trim();\r\n\r\n            const depNo1 = asText(emp.dep_no1 || emp.dep_no_1 || emp.department_no1 || emp.department_no_1);\r\n            const depNo2 = asText(emp.dep_no2 || emp.dep_no_2 || emp.department_no2 || emp.department_no_2);\r\n\r\n            const deptText = [depNo1, depNo2].filter(Boolean).join(' / ');\r\n            const eidText = asText(emp.eid_no);\r\n\r\n            let info = '';\r\n            if (deptText) info += `Dept: ${deptText}`;\r\n            if (eidText) info += `${info ? ' | ' : ''}EID: ${eidText}`;\r\n\r\n            frm.set_value('linked_emp_info', info || '');\r\n        } catch (e) {\r\n            console.error('Failed to load employee:', e);\r\n            frm.set_value('linked_emp_info', '');\r\n        }\r\n    },\r\n\r\n    uid_no(frm) {\r\n        validate_uid_input(frm);\r\n    },\r\n\r\n    first_name(frm) {\r\n        validate_name_field(frm, 'first_name');\r\n    },\r\n\r\n    last_name(frm) {\r\n        validate_name_field(frm, 'last_name');\r\n    },\r\n\r\n    before_save(frm) {\r\n        frm.__was_insert = frm.is_new();\r\n    },\r\n\r\n    async after_save(frm) {\r\n        const justCreated = Boolean(frm.__was_insert);\r\n        delete frm.__was_insert;\r\n\r\n        const choice = frm.__post_save_choice || 'stay';\r\n        frm.__post_save_choice = null;\r\n\r\n        const defaultMessage = justCreated ? __('Saved Successfully') : __('Updated Successfully');\r\n        const defaultIndicator = justCreated ? 'green' : 'blue';\r\n\r\n        if (!justCreated) {\r\n            if (choice === 'update') {\r\n                frappe.show_alert({\r\n                    message: defaultMessage,\r\n                    indicator: defaultIndicator\r\n                });\r\n            }\r\n            return;\r\n        }\r\n\r\n        if (choice === 'new') {\r\n            frappe.show_alert({\r\n                message: defaultMessage,\r\n                indicator: defaultIndicator\r\n            });\r\n            await frappe.new_doc('Customer Employee Registration');\r\n        } else {\r\n            frappe.show_alert({\r\n                message: __('Staying on current record'),\r\n                indicator: 'blue'\r\n            });\r\n        }\r\n    }\r\n});\r\n\r\n\r\nasync function enforce_dep_no_requirement(frm) {\r\n    const customer = frm.doc.customer_name;\r\n\r\n    if (!customer) {\r\n        apply_dep_no_requirement(frm, false);\r\n        frm.__dep_no_customer_flag = null;\r\n        return;\r\n    }\r\n\r\n    if (frm.__dep_no_customer_flag && frm.__dep_no_customer_flag.customer === customer) {\r\n        apply_dep_no_requirement(frm, frm.__dep_no_customer_flag.required);\r\n        return;\r\n    }\r\n\r\n    try {\r\n        const { message } = await frappe.db.get_value('Customer', customer, 'custom_emp_dep_id');\r\n        const required = cint(message?.custom_emp_dep_id) === 1;\r\n        frm.__dep_no_customer_flag = { customer, required };\r\n        apply_dep_no_requirement(frm, required);\r\n    } catch (e) {\r\n        console.error('Failed to check Emp Dep ID flag:', e);\r\n        apply_dep_no_requirement(frm, false);\r\n    }\r\n}\r\n\r\nfunction apply_dep_no_requirement(frm, required) {\r\n    const needsDepNo = Boolean(required);\r\n\r\n    frm.toggle_reqd('dep_no1', needsDepNo);\r\n    frm.toggle_reqd('dep_no2', needsDepNo);\r\n\r\n    frm.set_df_property('dep_no', 'read_only', needsDepNo ? 1 : 0);\r\n    frm.set_df_property(\r\n        'dep_no',\r\n        'description',\r\n        needsDepNo ? __('Required because Emp Dep ID is enabled for this customer.') : ''\r\n    );\r\n\r\n    if (needsDepNo && !frm.doc.dep_no) {\r\n        frm.set_value('dep_no', 1);\r\n    }\r\n}\r\n\r\nfunction apply_uid_requirement(frm) {\r\n    const uidRequired = !cint(frm.doc.new_employee);\r\n\r\n    frm.toggle_reqd('uid_no', uidRequired);\r\n    frm.set_df_property(\r\n        'uid_no',\r\n        'description',\r\n        uidRequired ? '' : __('UID not required while New Employee is enabled.')\r\n    );\r\n}\r\n\r\nfunction setup_save_confirmation(frm) {\r\n    if (frm.__save_interceptor_attached) {\r\n        return;\r\n    }\r\n\r\n    const originalSave = frm.save.bind(frm);\r\n\r\n    frm.save = function (...args) {\r\n        if (frm.doc.docstatus !== 0 || frm.__skip_save_confirm) {\r\n            return originalSave(...args);\r\n        }\r\n\r\n        const isInsert = frm.is_new();\r\n\r\n        return new Promise((resolve, reject) => {\r\n            const proceed = (choice) => {\r\n                frm.__post_save_choice = choice;\r\n                frm.__skip_save_confirm = true;\r\n                Promise.resolve(originalSave(...args))\r\n                    .then(resolve)\r\n                    .catch(reject)\r\n                    .finally(() => {\r\n                        frm.__skip_save_confirm = false;\r\n                    });\r\n            };\r\n\r\n            const cancel = () => {\r\n                frm.__post_save_choice = 'cancelled';\r\n                resolve();\r\n            };\r\n\r\n            if (isInsert) {\r\n                frappe.confirm(\r\n                    __('Save this record and create another?'),\r\n                    () => proceed('new'),\r\n                    () => proceed('stay')\r\n                );\r\n            } else {\r\n                frappe.confirm(\r\n                    __('Do you want to update this record?'),\r\n                    () => proceed('update'),\r\n                    cancel\r\n                );\r\n            }\r\n        });\r\n    };\r\n\r\n    frm.__save_interceptor_attached = true;\r\n}\r\n\r\nfunction validate_uid_input(frm) {\r\n    const value = (frm.doc.uid_no || '').trim();\r\n    if (!value) return;\r\n\r\n    const error = get_uid_error(value);\r\n    if (error) {\r\n        frappe.msgprint({\r\n            title: __('Invalid UID'),\r\n            indicator: 'red',\r\n            message: error\r\n        });\r\n        frm.set_value('uid_no', '');\r\n    }\r\n}\r\n\r\nfunction get_uid_error(value) {\r\n    if (!/^\\d+$/.test(value)) {\r\n        return __('UID must contain digits only.');\r\n    }\r\n\r\n    if (value.length < 7 || value.length > 15) {\r\n        return __('UID must be between 7 and 15 digits.');\r\n    }\r\n\r\n    if (/^(\\d)\\1+$/.test(value)) {\r\n        return __('UID cannot be the same digit repeated.');\r\n    }\r\n\r\n    if (is_sequential_digits(value)) {\r\n        return __('UID cannot be a sequential number.');\r\n    }\r\n\r\n    return '';\r\n}\r\n\r\nfunction is_sequential_digits(value) {\r\n    const digits = value.split('').map(d => parseInt(d, 10));\r\n    const asc = digits.every((digit, idx) => idx === 0 || digit - digits[idx - 1] === 1);\r\n    const desc = digits.every((digit, idx) => idx === 0 || digits[idx - 1] - digit === 1);\r\n    return asc || desc;\r\n}\r\n\r\nfunction validate_name_field(frm, fieldname) {\r\n    const raw = (frm.doc[fieldname] || '').trim();\r\n    if (!raw) return;\r\n\r\n    const error = get_name_error(raw);\r\n    if (error) {\r\n        frappe.msgprint({\r\n            title: __('Invalid Name'),\r\n            indicator: 'red',\r\n            message: error\r\n        });\r\n        frm.set_value(fieldname, '');\r\n    }\r\n}\r\n\r\nfunction get_name_error(value) {\r\n    const lowered = value.toLowerCase();\r\n    const plain = value.replace(/[^a-z]/gi, '');\r\n    const blacklist = ['none', 'other', 'test', 'dummy', 'sample', 'na', 'n/a'];\r\n\r\n    if (lowered.length < 2) {\r\n        return __('Name is too short.');\r\n    }\r\n\r\n    if (blacklist.includes(lowered)) {\r\n        return __('Placeholder names are not allowed.');\r\n    }\r\n\r\n    if (!plain) {\r\n        return __('Name must include alphabetic characters.');\r\n    }\r\n\r\n    if (/^\\d+$/.test(value.replace(/\\s+/g, ''))) {\r\n        return __('Name cannot be numbers only.');\r\n    }\r\n\r\n    if (/^([a-z])\\1+$/i.test(plain)) {\r\n        return __('Name cannot be the same letter repeated.');\r\n    }\r\n\r\n    if (!/[aeiouy]/i.test(plain)) {\r\n        return __('Name must contain a vowel.');\r\n    }\r\n\r\n    return '';\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Service Request",
  "enabled": 0,
  "modified": "2025-11-05 09:14:00.604885",
  "module": "Ag Docs",
  "name": "price_list-fetch",
  "script": "// ----------------------\n// PARENT: Service Request\n// ----------------------\nfrappe.ui.form.on('Service Request', {\n    refresh(frm) {\n        // Always default to Standard Selling if nothing loaded\n        if (!frm.doc.price_list) {\n            frm.set_value('price_list', 'Standard Selling');\n        }\n    },\n\n    async customer_name(frm) {\n        if (!frm.doc.customer_name) {\n            frm.set_value('price_list', 'Standard Selling');\n            return;\n        }\n\n        try {\n            // \ud83d\udd39 Fetch default price list from Customer\n            const { message } = await frappe.db.get_value('Customer', frm.doc.customer_name, ['default_price_list']);\n\n            // Set the price list accordingly\n            const selected_list = message?.default_price_list || 'Standard Selling';\n            await frm.set_value('price_list', selected_list);\n\n            frappe.show_alert({\n                message: `\ud83d\udcb0 Price List set to \"${selected_list}\"`,\n                indicator: 'green'\n            });\n        } catch (e) {\n            console.error('Error fetching customer price list:', e);\n            await frm.set_value('price_list', 'Standard Selling');\n        }\n\n        // \ud83d\udd01 Ensure it\u2019s reflected in doc model immediately\n        frm.refresh_field('price_list');\n        await frappe.timeout(0.1); // Give time for async update\n    }\n});\n// ----------------------\n// CHILD: Service Request Item\n// ----------------------\nfrappe.ui.form.on('Service Request Item', {\n    async item_code(frm, cdt, cdn) {\n        const row = locals[cdt][cdn];\n        const item_code = row.item_code;\n        if (!item_code) return;\n\n        // Get price list from parent\n        const price_list = frm.doc.price_list || 'Standard Selling';\n\n        // Fetch Gov Charge\n        let gov_rate = await get_item_rate(item_code, price_list);\n        if (!gov_rate && price_list !== 'Standard Selling') {\n            gov_rate = await get_item_rate(item_code, 'Standard Selling');\n        }\n\n        frappe.model.set_value(cdt, cdn, 'gov_charge', gov_rate || 0);\n\n        // Optional: calculate amount (if amount field exists)\n        if ('amount' in row) {\n            frappe.model.set_value(cdt, cdn, 'amount', (row.qty || 1) * (gov_rate || 0));\n        }\n\n        // Fetch SRV Item Price for optional table\n        const srv_item_code = 'SRV ' + item_code;\n        let srv_rate = await get_item_rate(srv_item_code, price_list);\n        if (!srv_rate && price_list !== 'Standard Selling') {\n            srv_rate = await get_item_rate(srv_item_code, 'Standard Selling');\n        }\n\n        const hasServiceChargeTable = Boolean(frm.fields_dict?.table_sgku);\n\n        if (srv_rate && hasServiceChargeTable) {\n            let srv_row = (frm.doc.table_sgku || []).find(r => r.item_code === srv_item_code);\n            if (!srv_row) {\n                srv_row = frm.add_child('table_sgku', {\n                    item_code: srv_item_code,\n                    qty: row.qty || 1,\n                    service_charge: srv_rate\n                });\n            } else {\n                frappe.model.set_value(srv_row.doctype, srv_row.name, 'service_charge', srv_rate);\n                frappe.model.set_value(srv_row.doctype, srv_row.name, 'qty', row.qty || 1);\n            }\n        } else if (srv_rate && !hasServiceChargeTable) {\n            console.warn('table_sgku field not found on Service Request; skipping SRV item sync');\n        }\n\n        frm.refresh_field('work_details');\n        if (hasServiceChargeTable) {\n            frm.refresh_field('table_sgku');\n        }\n    }\n});\n\n\n// ----------------------\n// Helper: Item Price Fetch\n// ----------------------\nasync function get_item_rate(item_code, price_list) {\n    const { message } = await frappe.db.get_value(\n        'Item Price',\n        { item_code: item_code, price_list: price_list, selling: 1 },\n        ['price_list_rate']\n    );\n    return message ? message.price_list_rate : 0;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Service Request",
  "enabled": 1,
  "modified": "2025-11-22 11:12:22.259437",
  "module": "Ag Docs",
  "name": "status",
  "script": "// =========================================================\n// Service Request - Working Version (ERPNext 15 compatible)\n// =========================================================\n\nfrappe.ui.form.on(\"Service Request\", {\n    onload(frm) {\n        update_status_summary(frm);\n    },\n    refresh(frm) {\n        update_status_summary(frm);\n    },\n    before_submit(frm) {\n        if (frm.doc.work_details?.length) {\n            const all_completed = frm.doc.work_details.every(\n                row => (row.status || \"\").trim().toLowerCase() === \"completed\"\n            );\n            if (!all_completed) {\n                frappe.throw({\n                    title: __(\"Cannot Submit\"),\n                    message: __(\n                        \"All items must be marked as <b>Completed</b> before submitting.<br><br>\" +\n                        \"Either:<ul><li>Update remaining items to <b>Completed</b></li>\" +\n                        \"<li>Or remove incomplete items from the list</li></ul>\"\n                    )\n                });\n            }\n        }\n    }\n});\n\nfrappe.ui.form.on(\"Service Request Item\", {\n    status(frm) {\n        update_status_summary(frm);\n    },\n    work_details_add(frm) {\n        update_status_summary(frm);\n    },\n    work_details_remove(frm) {\n        update_status_summary(frm);\n    }\n});\n\nfunction update_status_summary(frm) {\n    const table = frm.doc.work_details || [];\n\n    // \ud83d\uded1 When CANCELED - remove all colors and tags\n    if (frm.doc.docstatus === 2) {\n        render_html(frm, `<span style=\"color:gray;\">Canceled \u2014 status not applicable</span>`);\n        frm.page.set_indicator(\"Canceled\", \"gray\");\n        return;\n    }\n\n    if (!table.length) {\n        render_html(frm, `<span style=\"color:gray;\">No items yet</span>`);\n        frm.page.set_indicator(\"No Items\", \"gray\");\n        return;\n    }\n\n    // Count all statuses\n    const counts = {};\n    table.forEach(row => {\n        const status = (row.status || \"\").trim();\n        if (!status) return;\n        counts[status] = (counts[status] || 0) + 1;\n    });\n\n    // Color map (still used only if not canceled)\n    const color_map = {\n        \"Pending\": \"red\",\n        \"Waiting for Payment\": \"orange\",\n        \"Completed\": \"green\"\n    };\n\n    // Build HTML with counts\n    const html_parts = Object.entries(counts).map(([status, count]) => {\n        return `<span style=\"font-weight:500;\">\u25cf ${status} (${count})</span>`;\n    });\n\n    const html = `<div style=\"font-size:13px; line-height:1.6;\">${html_parts.join(\" &nbsp;|&nbsp; \")}</div>`;\n    render_html(frm, html);\n\n    // Header indicator\n    const all_completed = Object.keys(counts).length === 1 && counts[\"Completed\"] === table.length;\n\n    if (all_completed) {\n        frm.page.set_indicator(\"All Completed\", \"green\");\n    } else if (counts[\"Waiting for Payment\"]) {\n        frm.page.set_indicator(\"Waiting for Payment\", \"orange\");\n    } else if (counts[\"Pending\"]) {\n        frm.page.set_indicator(\"Pending\", \"red\");\n    } else {\n        frm.page.set_indicator(\"In Progress\", \"gray\");\n    }\n}\n\n// \u2705 Correct rendering for ERPNext 15 HTML field\nfunction render_html(frm, html) {\n    const field = frm.fields_dict[\"status_summary\"];\n    if (!field) {\n        console.warn(\"\u26a0\ufe0f status_summary field not found\");\n        return;\n    }\n    if (!field.$wrapper) {\n        frappe.ui.form.on(\"Service Request\", {\n            refresh(frm) {\n                frm.fields_dict[\"status_summary\"].$wrapper.html(html);\n            }\n        });\n        return;\n    }\n    field.$wrapper.html(html);\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Service Request",
  "enabled": 0,
  "modified": "2025-11-05 09:13:23.268536",
  "module": "Ag Docs",
  "name": "sale_order_cu",
  "script": "frappe.ui.form.on('Service Request', {\n    refresh(frm) {\n\n        // --- Create Sales Order ---\n        if (!frm.is_new()) {\n            frm.add_custom_button(__('Create Sales Order'), () => {\n                frappe.call({\n                    method: \"service_workorder.api.create_sales_order_from_service_request\",\n                    args: { service_request: frm.doc.name },\n                    callback: function(r) {\n                        if (r.message) {\n                            frappe.model.sync(r.message);\n                            frappe.set_route(\"Form\", r.message.doctype, r.message.name);\n                        }\n                    }\n                });\n            }, __('Create'));\n        }\n\n        // --- Create Sales Invoice ---\n        if (frm.doc.docstatus === 1 && !frm.doc.sales_order_ref) {\n            frm.add_custom_button(__('Create Sales Invoice'), () => {\n                frappe.call({\n                    method: \"service_workorder.api.create_sales_invoice_from_service_request\",\n                    args: { service_request: frm.doc.name },\n                    callback: function(r) {\n                        if (r.message) {\n                            frappe.model.sync(r.message);\n                            frappe.set_route(\"Form\", r.message.doctype, r.message.name);\n                        }\n                    }\n                });\n            }, __('Create'));\n        }\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Service Request",
  "enabled": 0,
  "modified": "2025-11-20 18:34:42.385434",
  "module": "Ag Docs",
  "name": "Diagnostic Script",
  "script": "// ======================================================\n// Helper Functions\n// ======================================================\n\n// 1\ufe0f\u20e3 Rebuild \"Taxes and Charges\" (table_sgku)\nfunction update_taxes_from_items(frm) {\n  if (!frm.fields_dict?.table_sgku) {\n    return;\n  }\n  frm.clear_table(\"table_sgku\");\n\n  let total_service_charge = 0;\n  (frm.doc.work_details || []).forEach(row => {\n    total_service_charge += (flt(row.service_charge) || 0) * (flt(row.qty) || 0);\n  });\n\n  if (total_service_charge > 0) {\n    const t = frm.add_child(\"table_sgku\");\n    t.account_head = \"Service Charges Income\";  // \ud83d\udd01 adjust if needed\n    t.charge_type = \"Actual\";\n    t.tax_amount = total_service_charge;\n\n    // \u2705 Fix for \"Missing Description\" validation\n    t.description = \"Total Service Charges\";  // \ud83d\udc48 Default text for mandatory field\n  }\n\n  frm.refresh_field(\"table_sgku\");\n  console.log(\"\u2705 Taxes updated \u2192\", total_service_charge);\n}\n\n// 2\ufe0f\u20e3 Fetch slab linked to customer\nasync function fetch_customer_slab(customer, company) {\n  if (!customer || !company) return null;\n\n  const res = await frappe.db.get_list(\"Customer Service Charge Link\", {\n    filters: { customer, company, enabled: 1 },\n    fields: [\"service_charge_slab\"],\n    limit: 1\n  });\n  return (res && res.length) ? res[0].service_charge_slab : null;\n}\n\n// 3\ufe0f\u20e3 Fetch item-specific service charge from slab\nasync function fetch_item_service_charge(slab_name, item_code) {\n  if (!slab_name || !item_code) return null;\n\n  const rows = await frappe.db.get_list(\"Service Charge Slab Item\", {\n    filters: { parent: slab_name, item: item_code },\n    fields: [\"service_charge\", \"tax_applicable\"],\n    limit: 1\n  });\n  return (rows && rows.length) ? rows[0] : null;\n}\n\n// 4\ufe0f\u20e3 Row amount recalculation (with frappe.model.set_value)\nfunction recalc_row_amount(frm, cdt, cdn) {\n  const row = locals[cdt][cdn];\n  const qty = flt(row.qty) || 0;\n  const gov = flt(row.gov_charge) || 0;\n  const srv = flt(row.service_charge) || 0;\n  const amount = qty * (gov + srv);\n\n  frappe.model.set_value(cdt, cdn, \"amount\", amount);\n}\n\n// ======================================================\n// Form Events \u2013 Service Request\n// ======================================================\n\nfrappe.ui.form.on(\"Service Request\", {\n  async customer(frm) {\n    if (!frm.doc.customer || !frm.doc.company) return;\n\n    const slab = await fetch_customer_slab(frm.doc.customer, frm.doc.company);\n    if (!slab) {\n      frappe.msgprint(\"\u26a0\ufe0f No active Service Charge Slab found for this Customer + Company.\");\n      frm.set_value(\"service_charge_slab\", \"\");\n      return;\n    }\n\n    await frm.set_value(\"service_charge_slab\", slab);\n    frappe.show_alert({ message: `Loaded Service Charge Slab: ${slab}`, indicator: \"green\" });\n    console.log(\"Loaded slab:\", slab);\n\n    // Apply slab to existing rows\n    for (const row of (frm.doc.work_details || [])) {\n      if (!row.item_code) continue;\n      const r = await fetch_item_service_charge(slab, row.item_code);\n      frappe.model.set_value(row.doctype, row.name, \"service_charge\", r ? r.service_charge : 0);\n      recalc_row_amount(frm, row.doctype, row.name);\n    }\n\n    frm.refresh_field(\"work_details\");\n    update_taxes_from_items(frm);\n  },\n\n refresh(frm) {\n    if (!frm.is_new() && frm.doc.work_details) {\n        update_taxes_from_items(frm);\n    }\n},\n\nvalidate(frm) {\n    // Run AFTER all fields are loaded\n    setTimeout(() => update_taxes_from_items(frm), 50);\n},\n\n\n  work_details_add(frm) {\n    update_taxes_from_items(frm);\n  },\n\n  work_details_remove(frm) {\n    update_taxes_from_items(frm);\n  }\n});\n\n// ======================================================\n// Child Table Events \u2013 Service Request Item\n// ======================================================\n\nfrappe.ui.form.on(\"Service Request Item\", {\n  item_code(frm, cdt, cdn) {\n    const row = locals[cdt][cdn];\n\n    if (!frm.doc.service_charge_slab) {\n      frappe.msgprint(\"\u26a0\ufe0f Select a customer with a valid Service Charge Slab first.\");\n      return;\n    }\n\n    if (!row.item_code) return;\n\n   frappe.call({\n  method: \"service_workorder.api.get_service_charge_from_slab\",\n  args: { slab_name: frm.doc.service_charge_slab, item_code: row.item_code },\n  callback: function (r) {\n    const srv = (r.message && r.message.service_charge) || 0;\n    frappe.model.set_value(cdt, cdn, \"service_charge\", srv);\n    recalc_row_amount(frm, cdt, cdn);\n    update_taxes_from_items(frm);\n  }\n});\n\n  },\n\n  qty(frm, cdt, cdn) {\n    recalc_row_amount(frm, cdt, cdn);\n    update_taxes_from_items(frm);\n  },\n\n  gov_charge(frm, cdt, cdn) {\n    recalc_row_amount(frm, cdt, cdn);\n    update_taxes_from_items(frm);\n  },\n\n  service_charge(frm, cdt, cdn) {\n    recalc_row_amount(frm, cdt, cdn);\n    update_taxes_from_items(frm);\n  }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Order",
  "enabled": 1,
  "modified": "2024-06-01 00:00:00.000000",
  "module": "Ag Docs",
  "name": "emp_filter_sales_order",
  "script": "(function() {\n    function toggleEmployeeFields(frm) {\n        var fields = ['custom_employee_type', 'custom_uid_no', 'custom_dep_no'];\n        fields.forEach(function(fieldname) {\n            var field = frm.fields_dict[fieldname];\n            if (field && field.$wrapper) {\n                var hasValue = !!frm.doc[fieldname];\n                field.$wrapper.toggle(hasValue);\n            }\n        });\n    }\n\n    function clearEmployeeFields(frm) {\n        frm.set_value('custom_employee', '');\n        frm.set_value('custom_employee_type', '');\n        frm.set_value('custom_uid_no', '');\n        frm.set_value('custom_dep_no', '');\n    }\n\n    function loadEmployee(frm, employee) {\n        if (!employee) {\n            toggleEmployeeFields(frm);\n            return;\n        }\n        frappe.db.get_value('Customer Employee Registration', employee, ['employee_type', 'uid_no', 'dep_no'], function(r) {\n            var value = r || {};\n            if (value.message) {\n                value = value.message;\n            }\n            frm.set_value('custom_employee_type', value.employee_type || '');\n            frm.set_value('custom_uid_no', value.uid_no || '');\n            frm.set_value('custom_dep_no', value.dep_no || '');\n            toggleEmployeeFields(frm);\n        });\n    }\n\n    frappe.ui.form.on('Sales Order', {\n        refresh: function(frm) {\n            if (!frm.is_new() && frm.doc.custom_employee && frm.doc.customer) {\n                loadEmployee(frm, frm.doc.custom_employee);\n            } else {\n                toggleEmployeeFields(frm);\n            }\n            frm.set_query('custom_employee', function() {\n                if (!frm.doc.customer) {\n                    return { filters: { name: ['is', 'not set'] } };\n                }\n                return { filters: { customer_name: frm.doc.customer, active: 1 } };\n            });\n        },\n        customer: function(frm) {\n            clearEmployeeFields(frm);\n            toggleEmployeeFields(frm);\n        },\n        custom_employee: function(frm) {\n            if (frm.doc.custom_employee) {\n                loadEmployee(frm, frm.doc.custom_employee);\n            } else {\n                clearEmployeeFields(frm);\n                toggleEmployeeFields(frm);\n            }\n        },\n        custom_employee_type: function(frm) { toggleEmployeeFields(frm); },\n        custom_uid_no: function(frm) { toggleEmployeeFields(frm); },\n        custom_dep_no: function(frm) { toggleEmployeeFields(frm); }\n    });\n})();",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Invoice",
  "enabled": 1,
  "modified": "2025-12-10 12:00:00.000000",
  "module": "Ag Docs",
  "name": "emp_filter_sales_invoice",
  "script": "(function() {\n    function toggleEmployeeFields(frm) {\n        var fields = ['custom_employee_type', 'custom_uid_no', 'custom_dep_no'];\n        fields.forEach(function(fieldname) {\n            var field = frm.fields_dict[fieldname];\n            if (field && field.$wrapper) {\n                var hasValue = !!frm.doc[fieldname];\n                field.$wrapper.toggle(hasValue);\n            }\n        });\n    }\n\n    function clearEmployeeFields(frm) {\n        frm.set_value('custom_employee', '');\n        frm.set_value('custom_employee_type', '');\n        frm.set_value('custom_uid_no', '');\n        frm.set_value('custom_dep_no', '');\n    }\n\n    function loadEmployee(frm, employee) {\n        if (!employee) {\n            toggleEmployeeFields(frm);\n            return;\n        }\n        frappe.db.get_value('Customer Employee Registration', employee, ['employee_type', 'uid_no', 'dep_no'], function(r) {\n            var value = r || {};\n            if (value.message) {\n                value = value.message;\n            }\n            frm.set_value('custom_employee_type', value.employee_type || '');\n            frm.set_value('custom_uid_no', value.uid_no || '');\n            frm.set_value('custom_dep_no', value.dep_no || '');\n            toggleEmployeeFields(frm);\n        });\n    }\n\n    frappe.ui.form.on('Sales Invoice', {\n        refresh: function(frm) {\n            if (!frm.is_new() && frm.doc.custom_employee && frm.doc.customer) {\n                loadEmployee(frm, frm.doc.custom_employee);\n            } else {\n                toggleEmployeeFields(frm);\n            }\n            frm.set_query('custom_employee', function() {\n                if (!frm.doc.customer) {\n                    return { filters: { name: ['is', 'not set'] } };\n                }\n                return { filters: { customer_name: frm.doc.customer, active: 1 } };\n            });\n        },\n        customer: function(frm) {\n            clearEmployeeFields(frm);\n            toggleEmployeeFields(frm);\n        },\n        custom_employee: function(frm) {\n            if (frm.doc.custom_employee) {\n                loadEmployee(frm, frm.doc.custom_employee);\n            } else {\n                clearEmployeeFields(frm);\n                toggleEmployeeFields(frm);\n            }\n        },\n        custom_employee_type: function(frm) { toggleEmployeeFields(frm); },\n        custom_uid_no: function(frm) { toggleEmployeeFields(frm); },\n        custom_dep_no: function(frm) { toggleEmployeeFields(frm); }\n    });\n})();",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Order",
  "enabled": 1,
  "modified": "2024-06-01 00:00:00.000000",
  "module": "Ag Docs",
  "name": "service_chrg_auto",
  "script": "(function() {\n    var DOC = 'Sales Order';\n    var CHILD = 'Sales Order Item';\n    var DOC_TOTAL_FIELD = 'custom_total_with_service_charge';\n    var ITEM_TOTAL_FIELD = 'custom_total_with_service_charge';\n    var ITEM_SC_FIELD = 'custom_service_charge';\n    var SLAB_FIELD = 'custom_service_charge_slab';\n    var scheduleTaxRefresh = frappe.utils.debounce(function(frm) {\n        frm.trigger('calculate_taxes_and_totals');\n    }, 200);\n\n    frappe.ui.form.on(DOC, {\n        refresh: function(frm) {\n            recalcAllRows(frm);\n        },\n        customer: function(frm) {\n            handleCustomerChange(frm);\n        },\n        items_add: function(frm, cdt, cdn) {\n            applyServiceCharge(frm, cdt, cdn);\n        },\n        items_remove: function(frm) {\n            computeTotals(frm);\n        }\n    });\n\n    frappe.ui.form.on(CHILD, {\n        item_code: function(frm, cdt, cdn) {\n            applyServiceCharge(frm, cdt, cdn);\n        },\n        qty: function(frm, cdt, cdn) {\n            recalcRow(frm, cdt, cdn);\n        },\n        rate: function(frm, cdt, cdn) {\n            recalcRow(frm, cdt, cdn);\n        },\n        custom_service_charge: function(frm, cdt, cdn) {\n            recalcRow(frm, cdt, cdn);\n        }\n    });\n\n    function handleCustomerChange(frm) {\n        if (!frm.doc.customer) {\n            frm.set_value(SLAB_FIELD, '');\n            clearItemCharges(frm);\n            computeTotals(frm);\n            return;\n        }\n        loadServiceChargeSlab(frm);\n    }\n\n    function loadServiceChargeSlab(frm) {\n        frappe.db.get_value('Customer Service Charge Link', {\n            customer: frm.doc.customer,\n            enabled: 1\n        }, 'service_charge_slab', function(r) {\n            var value = getValue(r, 'service_charge_slab');\n            frm.set_value(SLAB_FIELD, value || '');\n            (frm.doc.items || []).forEach(function(row) {\n                applyServiceChargeToRow(frm, row);\n            });\n        });\n    }\n\n    function applyServiceCharge(frm, cdt, cdn) {\n        var row = locals[cdt][cdn];\n        if (row) {\n            applyServiceChargeToRow(frm, row);\n        }\n    }\n\n    function applyServiceChargeToRow(frm, row) {\n        if (!row.item_code) {\n            return;\n        }\n        var slab = frm.doc[SLAB_FIELD];\n        if (!slab) {\n            frappe.model.set_value(row.doctype, row.name, ITEM_SC_FIELD, 0);\n            recalcRow(frm, row.doctype, row.name);\n            return;\n        }\n        frappe.call({\n            method: 'service_workorder.api.get_service_charge_from_slab',\n            args: { slab_name: slab, item_code: row.item_code },\n            callback: function(r) {\n                var amount = 0;\n                if (r && r.message && typeof r.message.service_charge !== 'undefined') {\n                    amount = flt(r.message.service_charge);\n                }\n                frappe.model.set_value(row.doctype, row.name, ITEM_SC_FIELD, amount);\n                recalcRow(frm, row.doctype, row.name);\n            }\n        });\n    }\n\n    function recalcAllRows(frm) {\n        (frm.doc.items || []).forEach(function(row) {\n            recalcRow(frm, row.doctype, row.name);\n        });\n    }\n\n    function recalcRow(frm, cdt, cdn) {\n        var row = locals[cdt][cdn];\n        if (!row) {\n            return;\n        }\n        var qty = flt(row.qty) || 0;\n        var rate = flt(row.rate) || 0;\n        var serviceCharge = flt(row[ITEM_SC_FIELD]) || 0;\n        var baseAmount = qty * rate;\n        var totalWithService = baseAmount + (qty * serviceCharge);\n        frappe.model.set_value(cdt, cdn, ITEM_TOTAL_FIELD, totalWithService);\n        computeTotals(frm);\n    }\n\n    function clearItemCharges(frm) {\n        (frm.doc.items || []).forEach(function(row) {\n            frappe.model.set_value(row.doctype, row.name, ITEM_SC_FIELD, 0);\n            if (ITEM_BASE_FIELD) {\n                frappe.model.set_value(row.doctype, row.name, ITEM_BASE_FIELD, 0);\n            }\n            frappe.model.set_value(row.doctype, row.name, ITEM_TOTAL_FIELD, 0);\n        });\n    }\n\n    function computeTotals(frm) {\n        var totalWithService = 0;\n        var totalServiceCharge = 0;\n        (frm.doc.items || []).forEach(function(row) {\n            totalWithService += flt(row[ITEM_TOTAL_FIELD]) || 0;\n            totalServiceCharge += (flt(row[ITEM_SC_FIELD]) || 0) * (flt(row.qty) || 0);\n        });\n        frm.set_value(DOC_TOTAL_FIELD, totalWithService);\n        syncServiceChargeTax(frm, totalServiceCharge);\n    }\n\n    function syncServiceChargeTax(frm, amount) {\n        var taxRow = getActualTaxRow(frm);\n        if (!taxRow) {\n            return;\n        }\n        var conversionRate = flt(frm.doc.conversion_rate || 1);\n        var baseAmount = flt(amount) * conversionRate;\n        frappe.model.set_value(taxRow.doctype, taxRow.name, 'tax_amount', amount);\n        frappe.model.set_value(taxRow.doctype, taxRow.name, 'base_tax_amount', baseAmount);\n        frappe.model.set_value(taxRow.doctype, taxRow.name, 'tax_amount_after_discount_amount', amount);\n        frappe.model.set_value(taxRow.doctype, taxRow.name, 'base_tax_amount_after_discount_amount', baseAmount);\n        frm.refresh_field('taxes');\n        scheduleTaxRefresh(frm);\n    }\n\n    function getActualTaxRow(frm) {\n        var taxes = frm.doc.taxes || [];\n        for (var i = 0; i < taxes.length; i++) {\n            var chargeType = taxes[i].charge_type || '';\n            if (chargeType.toLowerCase() === 'actual') {\n                return taxes[i];\n            }\n        }\n        return null;\n    }\n\n    function getValue(response, fieldname) {\n        if (!response) {\n            return '';\n        }\n        if (typeof response[fieldname] !== 'undefined') {\n            return response[fieldname];\n        }\n        if (response.message && typeof response.message[fieldname] !== 'undefined') {\n            return response.message[fieldname];\n        }\n        return '';\n    }\n})();",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Order",
  "enabled": 1,
  "modified": "2024-06-01 00:00:00.000000",
  "module": "Ag Docs",
  "name": "service_charge",
  "script": "// Deprecated",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Order",
  "enabled": 1,
  "modified": "2024-06-01 00:00:00.000000",
  "module": "Ag Docs",
  "name": "prnt_auto_select",
  "script": "(function() {\n    function setSalesOrderPrintFormat(frm) {\n        if (!frm.doc || !frm.doc.naming_series) {\n            return;\n        }\n        var series = frm.doc.naming_series || '';\n        var target = null;\n        if (series.indexOf('SAL-ORD') === 0) {\n            target = 'Tax Sales Order';\n        } else if (series.indexOf('ORD-') === 0) {\n            target = 'Order No VAT';\n        }\n        if (target) {\n            frm.doc.__print_format = target;\n            frm.meta.default_print_format = target;\n        }\n    }\n\n    frappe.ui.form.on('Sales Order', {\n        refresh: function(frm) {\n            if (frm.doc && frm.doc.name && frm.doc.naming_series) {\n                setSalesOrderPrintFormat(frm);\n            }\n        },\n        naming_series: function(frm) {\n            setSalesOrderPrintFormat(frm);\n        },\n        after_save: function(frm) {\n            setSalesOrderPrintFormat(frm);\n        }\n    });\n})();",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Order",
  "enabled": 1,
  "modified": "2024-06-01 00:00:00.000000",
  "module": "Ag Docs",
  "name": "naming_filter_ord",
  "script": "(function() {\n    frappe.ui.form.on('Sales Order', {\n        customer: function(frm) {\n            if (!frm.doc.customer) {\n                frm.set_value('naming_series', '');\n                return;\n            }\n            frappe.db.get_value('Customer', frm.doc.customer, 'customer_group', function(r) {\n                var value = '';\n                if (r) {\n                    if (typeof r.customer_group !== 'undefined') {\n                        value = r.customer_group;\n                    } else if (r.message && typeof r.message.customer_group !== 'undefined') {\n                        value = r.message.customer_group;\n                    }\n                }\n                var group = value || '';\n                var series = 'ORD-.YYYY.-';\n                if (group === 'VAT') {\n                    series = 'SAL-ORD-.YYYY.-';\n                } else if (group === 'NON VAT') {\n                    series = 'ORD-.YYYY.-';\n                }\n                frm.set_value('naming_series', series);\n            });\n        }\n    });\n})();",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Order",
  "enabled": 1,
  "modified": "2024-06-01 00:00:00.000000",
  "module": "Ag Docs",
  "name": "clear fields",
  "script": "(function() {\n    frappe.ui.form.on('Sales Order', {\n        customer: function(frm) {\n            if (frm.doc.customer) {\n                return;\n            }\n            frm.set_value('custom_service_charge_slab', '');\n            frm.set_value('selling_price_list', '');\n            (frm.doc.items || []).forEach(function(row) {\n                frappe.model.set_value(row.doctype, row.name, 'custom_service_charge', 0);\n                frappe.model.set_value(row.doctype, row.name, 'rate', 0);\n                frappe.model.set_value(row.doctype, row.name, 'custom_total_with_service_charge', 0);\n            });\n            frm.refresh_field('items');\n            frm.set_value('custom_total_with_service_charge', 0);\n            frm.trigger('calculate_taxes_and_totals');\n        }\n    });\n})();",
  "view": "Form"
 }
]