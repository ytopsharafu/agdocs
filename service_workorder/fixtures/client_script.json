[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Invoice",
  "enabled": 1,
  "modified": "2025-11-28 18:42:13.786637",
  "module": "Ag Docs",
  "name": "service_charge_purchase inv",
  "script": "// ========================================================\r\n// üéØ Purchase Invoice - ITEM-LEVEL & TOTAL CALCULATIONS\r\n// ========================================================\r\nfrappe.ui.form.on('Purchase Invoice', {\r\n    refresh(frm) {\r\n        // üßÆ Auto-recalculate totals when opening an existing draft or saved invoice\r\n        if (!frm.is_new()) {\r\n            (frm.doc.items || []).forEach(row => {\r\n                if (row.item_code) {\r\n                    update_row_and_taxes(frm, row.doctype, row.name);\r\n                }\r\n            });\r\n        }\r\n    }\r\n});\r\nfrappe.ui.form.on('Purchase Invoice Item', {\r\n    qty: function(frm, cdt, cdn) { update_row_and_taxes(frm, cdt, cdn); },\r\n    rate: function(frm, cdt, cdn) { update_row_and_taxes(frm, cdt, cdn); },\r\n    custom_service_charge: function(frm, cdt, cdn) { update_row_and_taxes(frm, cdt, cdn); },\r\n    items_remove: function(frm) { update_total_service_charge(frm); }\r\n});\r\n\r\nfunction update_row_and_taxes(frm, cdt, cdn) {\r\n    let row = frappe.get_doc(cdt, cdn);\r\n\r\n    let qty = flt(row.qty);\r\n    let rate = flt(row.rate);\r\n    let sc = flt(row.custom_service_charge);\r\n\r\n    // üßÆ Per-row calculations\r\n    let amount = qty * rate;\r\n    let total_with_service = (qty * rate) + (qty * sc);\r\n\r\n    row.amount = amount;\r\n    row.custom_total_with_service_charge = total_with_service;\r\n\r\n    frm.refresh_field('items');\r\n    update_total_service_charge(frm);\r\n}\r\n\r\nfunction update_total_service_charge(frm) {\r\n    let total_service_charge = 0;\r\n    let total_with_service_charge = 0;\r\n\r\n    (frm.doc.items || []).forEach(row => {\r\n        total_service_charge += flt(row.custom_service_charge) * flt(row.qty);\r\n        total_with_service_charge += flt(row.custom_total_with_service_charge);\r\n    });\r\n\r\n    // üéØ Update first \"Actual\" tax row (Service Charge template)\r\n    if (frm.doc.taxes && frm.doc.taxes.length > 0) {\r\n        let tax_row = frm.doc.taxes[0];\r\n        tax_row.tax_amount = total_service_charge;\r\n        tax_row.total = total_service_charge;\r\n        frm.refresh_field('taxes');\r\n    }\r\n\r\n    // üßæ Update custom totals at invoice level\r\n    frm.set_value(\"custom_total_with_service_charge\", total_with_service_charge);\r\n\r\n    // Recalculate ERPNext system totals\r\n    frm.trigger('calculate_taxes_and_totals');\r\n}\r\n\r\n// ========================================================\r\n// 1Ô∏è‚É£ AUTO LOAD SLAB BASED ON CUSTOMER\r\n// ========================================================\r\nfrappe.ui.form.on('Purchase Invoice', {\r\n    async customer(frm) {\r\n        if (!frm.doc.customer) return;\r\n\r\n        try {\r\n            let link = await frappe.db.get_value(\r\n                \"Customer Service Charge Link\",\r\n                { customer: frm.doc.customer, enabled: 1 },\r\n                \"service_charge_slab\"\r\n            );\r\n\r\n            frm.set_value(\"custom_service_charge_slab\", link?.message?.service_charge_slab || \"\");\r\n        } catch (e) {\r\n            console.error(\"Error fetching slab:\", e);\r\n        }\r\n    }\r\n});\r\n\r\n// ========================================================\r\n// 2Ô∏è‚É£ FETCH & APPLY SERVICE CHARGE PER ITEM\r\n// ========================================================\r\nfrappe.ui.form.on('Purchase Invoice Item', {\r\n    async item_code(frm, cdt, cdn) {\r\n        let row = frappe.get_doc(cdt, cdn);\r\n        let slab = frm.doc.custom_service_charge_slab;\r\n\r\n        if (!row.item_code) return;\r\n\r\n        if (!slab) {\r\n            frappe.model.set_value(cdt, cdn, \"custom_service_charge\", 0);\r\n            update_row_and_taxes(frm, cdt, cdn);\r\n            return;\r\n        }\r\n\r\n        try {\r\n            let result = await frappe.call({\r\n                method: \"service_workorder.api.get_service_charge_from_slab\",\r\n                args: { \r\n                    slab_name: slab, \r\n                    item_code: row.item_code \r\n                }\r\n            });\r\n\r\n            let sc = result?.message?.service_charge || 0;\r\n            frappe.model.set_value(cdt, cdn, \"custom_service_charge\", flt(sc));\r\n\r\n            update_row_and_taxes(frm, cdt, cdn);\r\n        } catch (e) {\r\n            console.error(\"Service charge fetch error:\", e);\r\n        }\r\n    },\r\n\r\n    // recalc when quantity, rate, or service charge changes\r\n    qty: function(frm, cdt, cdn) { update_row_and_taxes(frm, cdt, cdn); },\r\n    rate: function(frm, cdt, cdn) { update_row_and_taxes(frm, cdt, cdn); },\r\n    custom_service_charge: function(frm, cdt, cdn) { update_row_and_taxes(frm, cdt, cdn); },\r\n    items_remove: function(frm) { update_total_service_charge(frm); }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Invoice",
  "enabled": 1,
  "modified": "2025-11-08 17:29:58.767483",
  "module": "Ag Docs",
  "name": "naming_filter",
  "script": "// üéØ Auto change Sales Invoice naming series based on Customer Group\r\n\r\nfrappe.ui.form.on('Sales Invoice', {\r\n    async customer(frm) {\r\n        // Stop if no customer is selected\r\n        if (!frm.doc.customer) {\r\n            frm.set_value('naming_series', '');\r\n            return;\r\n        }\r\n\r\n        try {\r\n            // Fetch the customer's group\r\n            const { message } = await frappe.db.get_value('Customer', frm.doc.customer, 'customer_group');\r\n            if (!message) return;\r\n\r\n            const group = message.customer_group;\r\n\r\n            // Set naming series based on customer group\r\n            if (group === \"VAT\") {\r\n                frm.set_value('naming_series', 'ACC-SINV-.YYYY.-');\r\n            } else if (group === \"NON VAT\") {\r\n                frm.set_value('naming_series', 'INV-.YYYY.-');\r\n            } else {\r\n                // Default fallback if group doesn‚Äôt match\r\n                frm.set_value('naming_series', 'INV-.YYYY.-');\r\n            }\r\n\r\n            // Optional: show small toast\r\n            frappe.show_alert({\r\n                message: `üìõ Series set for ${group}`,\r\n                indicator: 'green'\r\n            });\r\n\r\n        } catch (e) {\r\n            console.error(\"Error fetching customer group:\", e);\r\n        }\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Service Request",
  "enabled": 1,
  "modified": "2025-11-15 13:49:12.878351",
  "module": "Ag Docs",
  "name": "collapse",
  "script": "frappe.ui.form.on(\"Service Request\", {\n    refresh(frm) {\n        // Replace 'no_label' with your actual Section Break fieldname\n        let section = frm.fields_dict.section_details;\n        if (section && section.collapse) {\n            // Force collapse regardless of data\n            section.collapse(true);\n        }\n        \n        \n    }\n    \n});\n\nfrappe.ui.form.on(\"Service Request\", {\n    refresh(frm) {\n        // Replace 'no_label' with your actual Section Break fieldname\n        let section = frm.fields_dict.price_list_and_slab;\n        if (section && section.collapse) {\n            // Force collapse regardless of data\n            section.collapse(true);\n        }\n        \n        \n    }\n    \n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Service Charge Slab",
  "enabled": 1,
  "modified": "2025-11-11 11:39:27.003978",
  "module": "Ag Docs",
  "name": "duplicate_item_check",
  "script": "frappe.ui.form.on(\"Service Charge Slab\", {\n    refresh(frm) {\n        // Perform an initial duplicate check\n        check_duplicate_items(frm);\n    },\n\n    validate: async function(frm) {\n        // 1Ô∏è‚É£ Check for duplicate items before saving\n        const duplicates = find_duplicate_items(frm);\n        if (duplicates.length > 0) {\n            frappe.throw(\n                __(\"‚ö†Ô∏è Duplicate Item(s) found: {0}. Please remove them before saving.\", \n                    [duplicates.join(\", \")])\n            );\n        }\n\n        // 2Ô∏è‚É£ Check for duplicate Slab Name (fixed filters)\n        if (frm.doc.slab_name) {\n            const existing = await frappe.db.get_list(\"Service Charge Slab\", {\n                filters: [\n                    [\"slab_name\", \"=\", frm.doc.slab_name],\n                    [\"name\", \"!=\", frm.doc.name]\n                ],\n                limit: 1\n            });\n\n            if (existing.length > 0) {\n                frappe.throw(\n                    __(\"‚ö†Ô∏è Slab Name '{0}' already exists. Please choose another name.\", \n                        [frm.doc.slab_name])\n                );\n            }\n        }\n    }\n});\n\nfrappe.ui.form.on(\"Service Charge Slab Item\", {\n    item(frm, cdt, cdn) {\n        check_duplicate_items(frm);\n    },\n    table_fxxp_add(frm, cdt, cdn) {\n        check_duplicate_items(frm);\n    },\n});\n\nfunction find_duplicate_items(frm) {\n    const seen = new Set();\n    const duplicates = new Set();\n\n    (frm.doc.table_fxxp || []).forEach(r => {\n        if (r.item) {\n            if (seen.has(r.item)) duplicates.add(r.item);\n            seen.add(r.item);\n        }\n    });\n    return Array.from(duplicates);\n}\n\nfunction check_duplicate_items(frm) {\n    if (!frm.fields_dict.table_fxxp) return;\n\n    const duplicates = find_duplicate_items(frm);\n    const grid = frm.fields_dict.table_fxxp.grid;\n\n    grid.grid_rows.forEach(gr => {\n        const row = gr.doc;\n        if (duplicates.includes(row.item)) {\n            $(gr.wrapper).addClass('duplicate-row');\n        } else {\n            $(gr.wrapper).removeClass('duplicate-row');\n        }\n    });\n\n    let warning_area = $(frm.fields_dict.table_fxxp.wrapper).find(\".duplicate-warning\");\n    if (warning_area.length === 0) {\n        warning_area = $('<div class=\"duplicate-warning\" style=\"margin-top:6px;font-size:12px;color:#b30000;\"></div>')\n            .appendTo(frm.fields_dict.table_fxxp.wrapper);\n    }\n\n    if (duplicates.length > 0) {\n        warning_area.html(`‚ö†Ô∏è Duplicate item(s) detected: <b>${duplicates.join(\", \")}</b>`);\n    } else {\n        warning_area.html(\"\");\n    }\n}\n\nfrappe.ui.form.on(\"Service Charge Slab\", \"onload\", function(frm) {\n    frappe.dom.add_stylesheet(`\n        .grid-body .rows .duplicate-row {\n            background-color: #ffe6e6 !important;\n        }\n    `);\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Customer Service Charge Link",
  "enabled": 1,
  "modified": "2025-11-10 19:45:48.552144",
  "module": "Ag Docs",
  "name": "duplicate_cust_check_link",
  "script": "frappe.ui.form.on(\"Customer Service Charge Link\", {\n    // ‚úÖ New live helper text\n    customer(frm) {\n        if (!frm.doc.customer) return;\n\n        frappe.db.get_value(\n            \"Customer Service Charge Link\",\n            { customer: frm.doc.customer, enabled: 1 },\n            [\"service_charge_slab\"]\n        ).then(r => {\n            if (r && r.message && r.message.service_charge_slab) {\n                frm.set_df_property(\n                    \"customer\",\n                    \"description\",\n                    __(\"‚úÖ Existing Slab: {0}\", [r.message.service_charge_slab])\n                );\n            } else {\n                frm.set_df_property(\n                    \"customer\",\n                    \"description\",\n                    __(\"‚ö†Ô∏è No Service Charge Slab linked yet.\")\n                );\n            }\n            frm.refresh_field(\"customer\");\n        });\n    },\n\n    refresh(frm) {\n        frm.set_df_property(\"customer\", \"description\", \"\");\n    },\n\n    // ‚úÖ Keep your duplicate check section here\n    validate(frm) {\n        if (frm.doc.customer && frm.doc.service_charge_slab) {\n            frappe.call({\n                method: \"frappe.client.get_list\",\n                args: {\n                    doctype: \"Customer Service Charge Link\",\n                    filters: {\n                        customer: frm.doc.customer,\n                        service_charge_slab: frm.doc.service_charge_slab,\n                        name: [\"!=\", frm.doc.name]\n                    },\n                    fields: [\"name\"]\n                },\n                async: false,\n                callback: function (r) {\n                    if (r.message && r.message.length > 0) {\n                        frappe.throw(\n                            __(\"‚ö†Ô∏è Duplicate combination found: This Service Charge Slab is already linked for the selected Customer.\")\n                        );\n                    }\n                }\n            });\n        }\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Service Request",
  "enabled": 0,
  "modified": "2025-11-13 12:08:50.057234",
  "module": "Ag Docs",
  "name": "gov_charge_load",
  "script": "// =============================\n// SERVICE REQUEST CLIENT SCRIPT\n// =============================\n\n// 1Ô∏è‚É£ When Customer is selected ‚Üí Load Price List\nfrappe.ui.form.on('Service Request', {\n    customer: async function(frm) {\n        if (!frm.doc.customer) return;\n\n        // Fetch default price list for this customer\n        let price_list = await frappe.db.get_value(\n            \"Customer\",\n            frm.doc.customer,\n            \"default_price_list\"\n        );\n\n        if (price_list && price_list.message && price_list.message.default_price_list) {\n            frm.set_value(\"price_list\", price_list.message.default_price_list);\n        } else {\n            frm.set_value(\"price_list\", \"\");\n        }\n        frm.refresh_field(\"price_list\");\n    }\n});\n\nfrappe.ui.form.on('Service Request', {\n    price_list: function(frm) {\n        frm.doc.work_details.forEach(row => {\n            frappe.model.set_value(row.doctype, row.name, 'item_code', row.item_code);\n        });\n    }\n});\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Service Request",
  "enabled": 0,
  "modified": "2025-11-13 12:08:56.438733",
  "module": "Ag Docs",
  "name": "gov_charge_load 01",
  "script": "// =============================\n// SERVICE REQUEST ITEM SCRIPT\n// =============================\n\nfrappe.ui.form.on('Service Request Item', {\n    item_code: async function(frm, cdt, cdn) {\n        let row = frappe.get_doc(cdt, cdn);\n        if (!row.item_code || !frm.doc.price_list) return;\n\n        // Fetch rate from Item Price based on Price List\n        let price_data = await frappe.db.get_value(\"Item Price\", {\n            item_code: row.item_code,\n            price_list: frm.doc.price_list\n        }, [\"price_list_rate\"]);\n\n        if (price_data && price_data.message && price_data.message.price_list_rate) {\n            frappe.model.set_value(cdt, cdn, \"gov_charge\", price_data.message.price_list_rate);\n        } else {\n            frappe.model.set_value(cdt, cdn, \"gov_charge\", 0);\n        }\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Customer Employee Registration",
  "enabled": 1,
  "modified": "2025-11-11 09:54:21.207044",
  "module": "Ag Docs",
  "name": "unique_check",
  "script": "frappe.ui.form.on('Customer Employee Registration', {\n    uid_no: function(frm) {\n        check_duplicate_inline(frm, 'uid_no');\n    },\n    passport_no: function(frm) {\n        check_duplicate_inline(frm, 'passport_no');\n    },\n    eid_no: function(frm) {\n        check_duplicate_inline(frm, 'eid_no');\n    }\n});\n\nasync function check_duplicate_inline(frm, fieldname) {\n    const value = frm.doc[fieldname];\n    if (!value) {\n        clear_inline_error(frm, fieldname);\n        return;\n    }\n\n    try {\n        const existing = await frappe.db.get_list('Customer Employee Registration', {\n            filters: [[fieldname, '=', value], ['name', '!=', frm.doc.name]],\n            limit: 1\n        });\n\n        const field = frm.fields_dict[fieldname];\n        const label = frappe.meta.get_label(frm.doc.doctype, fieldname);\n\n        if (existing.length > 0) {\n            // show inline red warning under the field\n            field.$wrapper.css(\"position\", \"relative\");\n            if (!field.$wrapper.find('.dup-warning').length) {\n                field.$wrapper.append(\n                    `<div class=\"dup-warning\" style=\"color:red; font-size:12px; margin-top:2px;\">\n                        ${label} already exists!\n                    </div>`\n                );\n            }\n        } else {\n            clear_inline_error(frm, fieldname);\n        }\n    } catch (e) {\n        console.error(e);\n    }\n}\n\nfunction clear_inline_error(frm, fieldname) {\n    frm.fields_dict[fieldname].$wrapper.find('.dup-warning').remove();\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Service Request",
  "enabled": 1,
  "modified": "2025-11-15 13:48:37.423811",
  "module": "Ag Docs",
  "name": "tax_and_cat",
  "script": "\nfrappe.provide(\"service_workorder.sr\");\n\nconst serviceRequestController = {\n    priceListCache: {},\n    slabCache: {},\n    govChargeCache: {},\n    serviceChargeCache: {},\n\n    async initialize(frm) {\n        await this.ensureDefaults(frm);\n    },\n\n    async ensureDefaults(frm) {\n        if (!frm.doc.customer || !frm.doc.company) {\n            return;\n        }\n        await Promise.all([\n            this.setPriceList(frm),\n            this.setServiceChargeSlab(frm),\n            this.setTaxCategoryAndTemplate(frm),\n        ]);\n    },\n\n    async handleCustomerOrCompanyChange(frm) {\n        await this.ensureDefaults(frm);\n        await this.refreshAllRows(frm);\n        this.updateTotals(frm);\n    },\n\n    async setPriceList(frm) {\n        if (!frm.doc.customer) return;\n        const key = `${frm.doc.customer}::${frm.doc.company || ''}`;\n        if (!(key in this.priceListCache)) {\n            let priceList = '';\n            const customer = await frappe.db.get_value('Customer', frm.doc.customer, 'default_price_list');\n            priceList = customer?.message?.default_price_list || '';\n            if (!priceList && frm.doc.company) {\n                const company = await frappe.db.get_value('Company', frm.doc.company, 'default_price_list');\n                priceList = company?.message?.default_price_list || '';\n            }\n            this.priceListCache[key] = priceList || 'Standard Selling';\n        }\n        if (frm.doc.price_list !== this.priceListCache[key]) {\n            await frm.set_value('price_list', this.priceListCache[key]);\n        }\n    },\n\n    async setServiceChargeSlab(frm) {\n        if (!frm.doc.customer) return;\n        const key = `${frm.doc.customer}::${frm.doc.company || ''}`;\n        if (!(key in this.slabCache)) {\n            const response = await frappe.db.get_value('Customer Service Charge Link', {\n                customer: frm.doc.customer,\n                company: frm.doc.company,\n                enabled: 1,\n            }, 'service_charge_slab');\n            this.slabCache[key] = response?.message?.service_charge_slab || '';\n        }\n        if (frm.doc.service_charge_slab !== this.slabCache[key]) {\n            await frm.set_value('service_charge_slab', this.slabCache[key]);\n        }\n    },\n\n    async setTaxCategoryAndTemplate(frm) {\n        if (!frm.doc.customer || !frm.doc.company) return;\n        const { message } = await frappe.db.get_value('Customer', frm.doc.customer, 'tax_category');\n        const taxCategory = message?.tax_category || '';\n        if (taxCategory && frm.doc.tax_category !== taxCategory) {\n            await frm.set_value('tax_category', taxCategory);\n        }\n        if (taxCategory) {\n            const templateResponse = await frappe.call({\n                method: 'service_workorder.api.get_sales_tax_template',\n                args: {\n                    company: frm.doc.company,\n                    tax_category: taxCategory,\n                },\n            });\n            const template = templateResponse?.message || '';\n            if (template && frm.doc.sales_taxes_and_charges_template !== template) {\n                await frm.set_value('sales_taxes_and_charges_template', template);\n            }\n        }\n    },\n\n    async loadTaxTemplate(frm) {\n        if (!frm.doc.sales_taxes_and_charges_template) return;\n        const response = await frappe.call({\n            method: 'service_workorder.api.load_sales_taxes',\n            args: { template_name: frm.doc.sales_taxes_and_charges_template },\n        });\n        frm.clear_table('taxes');\n        (response.message || []).forEach((tax) => {\n            const row = frm.add_child('taxes');\n            row.charge_type = tax.charge_type;\n            row.account_head = tax.account_head;\n            row.rate = tax.rate;\n            row.description = tax.description;\n        });\n        frm.refresh_field('taxes');\n        this.updateTotals(frm);\n    },\n\n    async refreshAllRows(frm) {\n        const rows = frm.doc.work_details || [];\n        for (const row of rows) {\n            await this.applyChargesForRow(frm, row);\n        }\n    },\n\n    async applyChargesForRow(frm, row) {\n        if (!row.item_code) return;\n        const govCharge = await this.getGovCharge(row.item_code, frm.doc.price_list);\n        const serviceCharge = await this.getServiceCharge(frm.doc.service_charge_slab, row.item_code);\n        frappe.model.set_value(row.doctype, row.name, 'gov_charge', govCharge);\n        frappe.model.set_value(row.doctype, row.name, 'service_charge', serviceCharge);\n        await this.setItemDetails(row);\n        this.updateRowAmount(row);\n    },\n\n    async getGovCharge(itemCode, priceList) {\n        if (!itemCode || !priceList) return 0;\n        const key = `${itemCode}::${priceList}`;\n        if (!(key in this.govChargeCache)) {\n            let value = await this.fetchItemPrice(itemCode, priceList);\n            if (!value && priceList !== 'Standard Selling') {\n                value = await this.fetchItemPrice(itemCode, 'Standard Selling');\n            }\n            this.govChargeCache[key] = flt(value || 0);\n        }\n        return this.govChargeCache[key];\n    },\n\n    async fetchItemPrice(itemCode, priceList) {\n        const result = await frappe.db.get_value('Item Price', { item_code: itemCode, price_list: priceList }, 'price_list_rate');\n        return result?.message?.price_list_rate || 0;\n    },\n\n    async getServiceCharge(slabName, itemCode) {\n        if (!slabName || !itemCode) return 0;\n        const key = `${slabName}::${itemCode}`;\n        if (!(key in this.serviceChargeCache)) {\n            const response = await frappe.call({\n                method: 'service_workorder.api.get_service_charge_from_slab',\n                args: { slab_name: slabName, item_code: itemCode },\n            });\n            this.serviceChargeCache[key] = flt(response?.message?.service_charge || 0);\n        }\n        return this.serviceChargeCache[key];\n    },\n\n    async setItemDetails(row) {\n        if (!row.item_code) return;\n        const itemResponse = await frappe.db.get_value('Item', row.item_code, 'item_group');\n        const itemGroup = itemResponse?.message?.item_group || '';\n        frappe.model.set_value(row.doctype, row.name, 'item_group', itemGroup);\n        if (!row.item_date) {\n            frappe.model.set_value(row.doctype, row.name, 'item_date', frappe.datetime.get_today());\n        }\n    },\n\n    updateRowAmount(row) {\n        const qty = flt(row.qty) || 0;\n        const gov = flt(row.gov_charge) || 0;\n        const service = flt(row.service_charge) || 0;\n        const amount = qty * (gov + service);\n        frappe.model.set_value(row.doctype, row.name, 'amount', amount);\n    },\n\n    updateTotals(frm) {\n        let govTotal = 0;\n        let serviceTotal = 0;\n        let baseTotal = 0;\n\n        (frm.doc.work_details || []).forEach((row) => {\n            const qty = flt(row.qty) || 0;\n            const gov = flt(row.gov_charge) || 0;\n            const service = flt(row.service_charge) || 0;\n            govTotal += gov * qty;\n            serviceTotal += service * qty;\n            baseTotal += (gov + service) * qty;\n        });\n\n        const taxes = frm.doc.taxes || [];\n        if (!taxes.length) return;\n\n        const serviceRow = taxes[0];\n        frappe.model.set_value(serviceRow.doctype, serviceRow.name, 'tax_amount', serviceTotal);\n        frappe.model.set_value(serviceRow.doctype, serviceRow.name, 'total', baseTotal);\n\n        if (taxes.length > 1) {\n            const vatRow = taxes[1];\n            const vatAmount = (serviceTotal * flt(vatRow.rate || 0)) / 100;\n            frappe.model.set_value(vatRow.doctype, vatRow.name, 'tax_amount', vatAmount);\n            frappe.model.set_value(vatRow.doctype, vatRow.name, 'total', baseTotal + vatAmount);\n        }\n\n        frm.refresh_field('taxes');\n    },\n};\n\nfrappe.ui.form.on('Service Request', {\n    async onload(frm) {\n        await serviceRequestController.initialize(frm);\n    },\n    async refresh(frm) {\n        await serviceRequestController.ensureDefaults(frm);\n        serviceRequestController.updateTotals(frm);\n    },\n    async customer(frm) {\n        await serviceRequestController.handleCustomerOrCompanyChange(frm);\n    },\n    async company(frm) {\n        await serviceRequestController.handleCustomerOrCompanyChange(frm);\n    },\n    async sales_taxes_and_charges_template(frm) {\n        await serviceRequestController.loadTaxTemplate(frm);\n    },\n});\n\nfrappe.ui.form.on('Service Request Item', {\n    async item_code(frm, cdt, cdn) {\n        const row = frappe.get_doc(cdt, cdn);\n        await serviceRequestController.applyChargesForRow(frm, row);\n        serviceRequestController.updateTotals(frm);\n    },\n    qty(frm, cdt, cdn) {\n        const row = frappe.get_doc(cdt, cdn);\n        serviceRequestController.updateRowAmount(row);\n        serviceRequestController.updateTotals(frm);\n    },\n    gov_charge(frm, cdt, cdn) {\n        const row = frappe.get_doc(cdt, cdn);\n        serviceRequestController.updateRowAmount(row);\n        serviceRequestController.updateTotals(frm);\n    },\n    service_charge(frm, cdt, cdn) {\n        const row = frappe.get_doc(cdt, cdn);\n        serviceRequestController.updateRowAmount(row);\n        serviceRequestController.updateTotals(frm);\n    },\n    work_details_add(frm, cdt, cdn) {\n        frappe.model.set_value(cdt, cdn, 'item_date', frappe.datetime.get_today());\n    },\n    work_details_remove(frm) {\n        serviceRequestController.updateTotals(frm);\n    },\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Service Request",
  "enabled": 0,
  "modified": "2025-11-15 13:48:59.370795",
  "module": "Ag Docs",
  "name": "slab_priclist",
  "script": "// =======================================================\n// SERVICE REQUEST ‚Äì PRICE LIST + GOV CHARGE + SLAB + SERVICE CHARGE\n// =======================================================\n\n// -----------------------------\n// 1Ô∏è‚É£ LOAD PRICE LIST\n// -----------------------------\nasync function load_price_list(frm) {\n    if (!frm.doc.customer || !frm.doc.company) return;\n\n    // Get Customer Default Price List\n    const cust = await frappe.db.get_value(\n        \"Customer\",\n        frm.doc.customer,\n        \"default_price_list\"\n    );\n\n    let price_list = cust?.message?.default_price_list || \"\";\n\n    // If Customer has no price list ‚Üí use Company default\n    if (!price_list) {\n        const comp = await frappe.db.get_value(\n            \"Company\",\n            frm.doc.company,\n            \"default_price_list\"\n        );\n        price_list = comp?.message?.default_price_list || \"\";\n    }\n\n    frm.set_value(\"price_list\", price_list);\n}\n\n\n\n// -----------------------------\n// 2Ô∏è‚É£ LOAD GOV CHARGE (ITEM PRICE LIST RATE)\n// -----------------------------\nasync function load_gov_charge(frm, cdt, cdn) {\n    let row = frappe.get_doc(cdt, cdn);\n\n    if (!row.item_code || !frm.doc.price_list) return;\n\n    const result = await frappe.call({\n        method: \"frappe.client.get_list\",\n        args: {\n            doctype: \"Item Price\",\n            filters: {\n                item_code: row.item_code,\n                price_list: frm.doc.price_list\n            },\n            fields: [\"price_list_rate\"],\n            limit_page_length: 1\n        }\n    });\n\n    let rate = result.message?.[0]?.price_list_rate || 0;\n    frappe.model.set_value(cdt, cdn, \"gov_charge\", rate);\n}\n\n\n\n// -----------------------------\n// 3Ô∏è‚É£ LOAD SLAB FROM CUSTOMER SERVICE CHARGE LINK (FIXED)\n// -----------------------------\nasync function load_slab(frm) {\n    if (!frm.doc.customer) return;\n\n    const res = await frappe.db.get_value(\n        \"Customer Service Charge Link\",\n        { customer: frm.doc.customer, enabled: 1 },\n        [\"service_charge_slab\"]   // ONLY THIS FIELD EXISTS\n    );\n\n    frm.set_value(\"service_charge_slab\", res?.message?.service_charge_slab || \"\");\n}\n\n\n\n// -----------------------------\n// 4Ô∏è‚É£ LOAD SERVICE CHARGE PER ITEM (FROM SLAB)\n// -----------------------------\nasync function load_service_charge(frm, cdt, cdn) {\n    let row = frappe.get_doc(cdt, cdn);\n    let slab = frm.doc.service_charge_slab;\n\n    if (!slab || !row.item_code) {\n        frappe.model.set_value(cdt, cdn, \"service_charge\", 0);\n        return;\n    }\n\n    const result = await frappe.call({\n        method: \"service_workorder.api.get_service_charge_from_slab\",\n        args: {\n            slab_name: slab,\n            item_code: row.item_code\n        }\n    });\n\n    let sc = result.message?.service_charge || 0;\n    frappe.model.set_value(cdt, cdn, \"service_charge\", sc);\n}\n\n\n\n// =======================================================\n// üîÑ HOOK EVENTS\n// =======================================================\n\nfrappe.ui.form.on(\"Service Request\", {\n    // When customer selected ‚Üí load price list & slab\n    async customer(frm) {\n        await load_price_list(frm);\n        await load_slab(frm);\n    }\n});\n\nfrappe.ui.form.on(\"Service Request Item\", {\n    async item_code(frm, cdt, cdn) {\n        await load_price_list(frm);             // reload price list\n        await load_gov_charge(frm, cdt, cdn);   // load gov charge\n        await load_service_charge(frm, cdt, cdn); // load slab service charge\n    }\n});\n\n\n// =======================================================\n// 5Ô∏è‚É£ CALCULATE TOTAL GOV CHARGE + SERVICE CHARGE\n// =======================================================\n\nfunction update_tax_totals(frm) {\n    let total_gov = 0;\n    let total_service = 0;\n\n    // Calculate totals from Work Details table\n    (frm.doc.work_details || []).forEach(row => {\n        let qty = flt(row.qty);\n        let gov = flt(row.gov_charge);\n        let sc = flt(row.service_charge);\n\n        total_gov += gov * qty;\n        total_service += sc * qty;\n    });\n\n    if (!frm.doc.taxes || frm.doc.taxes.length === 0) return;\n\n    let tax = frm.doc.taxes[0];\n\n    // FIX: Amount = service charge total\n    tax.tax_amount = total_service;\n\n    // FIX: Total = gov total + service total\n    tax.total = total_gov + total_service;\n\n    frm.refresh_field(\"taxes\");\n}\n\n\n\n// =======================================================\n// 6Ô∏è‚É£ TRIGGER UPDATE WHEN VALUES CHANGE\n// =======================================================\nfrappe.ui.form.on(\"Service Request Item\", {\n    qty(frm) { update_tax_totals(frm); },\n    gov_charge(frm) { update_tax_totals(frm); },\n    service_charge(frm) { update_tax_totals(frm); },\n    work_details_remove(frm) { update_tax_totals(frm); }\n});\n\nfrappe.ui.form.on(\"Service Request\", {\n    refresh(frm) { update_tax_totals(frm); }\n});\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Service Request",
  "enabled": 1,
  "modified": "2025-11-15 12:46:58.206069",
  "module": "Ag Docs",
  "name": "sales_ord_inv_btn",
  "script": "\nfrappe.ui.form.on(\"Service Request\", {\n    refresh(frm) {\n        // Remove default ERPNext create buttons and reset ours\n        frm.page.remove_inner_button(\"Sales Order\", \"Create\");\n        frm.page.remove_inner_button(\"Sales Invoice\", \"Create\");\n        frm.page.remove_inner_button(\"Create Sales Order\", \"Create\");\n        frm.page.remove_inner_button(\"Create Sales Invoice\", \"Create\");\n        frm.clear_custom_buttons();\n\n        // Only show buttons after the document is saved\n        if (frm.is_new()) {\n            return;\n        }\n\n        const alreadyLinked = frm.doc.sales_order_ref || frm.doc.sales_invoice_ref;\n\n        // ------------------------------------------------------\n        // Sales Order button (Draft only)\n        // ------------------------------------------------------\n        frm.add_custom_button(\"Create Sales Order\", () => {\n            if (alreadyLinked) {\n                frappe.msgprint(\"This Service Request already has a linked Sales Order or Invoice.\");\n                return;\n            }\n\n            if (frm.doc.docstatus !== 0) {\n                frappe.msgprint(\"Sales Orders can only be created while the Service Request is in Draft.\");\n                return;\n            }\n\n            frappe.confirm(\"Do you want to create a Sales Order?\", () => {\n                frappe.call({\n                    method: \"service_workorder.api.create_sales_order_from_service_request\",\n                    args: { service_request: frm.doc.name },\n                    freeze: true,\n                    freeze_message: \"Creating Sales Order...\",\n                    callback(r) {\n                        if (!r.message) {\n                            frappe.msgprint(\"Failed to create Sales Order\");\n                            return;\n                        }\n                        const soName = r.message.name;\n                        frappe.msgprint(\"Sales Order Created: \" + soName);\n                        frappe.set_route(\"Form\", \"Sales Order\", soName);\n                    }\n                });\n            });\n        }, \"Create\");\n\n        // ------------------------------------------------------\n        // Sales Invoice button (Submitted only)\n        // ------------------------------------------------------\n        frm.add_custom_button(\"Create Sales Invoice\", () => {\n            if (alreadyLinked) {\n                frappe.msgprint(\"This Service Request already has a linked Sales Order or Invoice.\");\n                return;\n            }\n\n            if (frm.doc.docstatus !== 1) {\n                frappe.msgprint(\"You can only create a Sales Invoice after the Service Request is submitted.\");\n                return;\n            }\n\n            frappe.confirm(\"Do you want to create a Sales Invoice?\", () => {\n                frappe.call({\n                    method: \"service_workorder.api.create_sales_invoice_from_service_request\",\n                    args: { service_request: frm.doc.name },\n                    freeze: true,\n                    freeze_message: \"Creating Sales Invoice...\",\n                    callback(r) {\n                        if (!r.message) {\n                            frappe.msgprint(\"Failed to create Sales Invoice\");\n                            return;\n                        }\n                        const siName = r.message.name;\n                        frappe.msgprint(\"Sales Invoice Created: \" + siName);\n                        frappe.set_route(\"Form\", \"Sales Invoice\", siName);\n                    }\n                });\n            });\n        }, \"Create\");\n    }\n});\n\nfrappe.ui.form.on(\"Service Request\", {\n    before_cancel(frm) {\n        return frappe.call({\n            method: \"service_workorder.api.validate_sr_cancel_or_delete\",\n            args: { sr_name: frm.doc.name },\n        });\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Customer Employee Registration",
  "enabled": 1,
  "modified": "2025-11-05 09:14:26.427147",
  "module": "Ag Docs",
  "name": "full_name",
  "script": "frappe.ui.form.on('Customer Employee Registration', {\n    first_name: function(frm) {\n        frm.set_value('full_name', (frm.doc.first_name || '') + ' ' + (frm.doc.last_name || ''));\n    },\n    last_name: function(frm) {\n        frm.set_value('full_name', (frm.doc.first_name || '') + ' ' + (frm.doc.last_name || ''));\n    },\n    employee_type: function(frm) {\n        if (frm.doc.employee_type === 'Dependent') {\n            frm.set_df_property('link_employee', 'hidden', 0);\n        } else {\n            frm.set_df_property('link_employee', 'hidden', 1);\n        }\n    },\n    customer: function(frm) {\n        frm.set_query('link_employee', function() {\n            return {\n                filters: {\n                    customer: frm.doc.customer,\n                    employee_type: 'Employee'\n                }\n            };\n        });\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Service Request",
  "enabled": 1,
  "modified": "2025-11-27 17:31:55.684308",
  "module": "Ag Docs",
  "name": "emp_filter",
  "script": "frappe.ui.form.on(\"Service Request\", {\r\n    refresh(frm) {\r\n        // Apply employee filter based on selected customer\r\n        frm.set_query(\"dep_emp_name\", () => {\r\n            if (!frm.doc.customer) {\r\n                return { filters: { customer_name: \"Select Customer\" } };\r\n            }\r\n            return { filters: { customer_name: frm.doc.customer } };\r\n        });\r\n\r\n        // Auto-load employee details\r\n        load_employee_details(frm);\r\n\r\n        // Check for existing draft requests\r\n        check_existing_draft(frm);\r\n    },\r\n\r\n    customer(frm) {\r\n        // Clear employee details when customer changed\r\n        frm.set_value({\r\n            dep_emp_name: null,\r\n            employee_type: null,\r\n            uid_no: null,\r\n            department_no: null\r\n        });\r\n        frm.refresh_fields();\r\n    },\r\n\r\n    dep_emp_name(frm) {\r\n        // Load employee details when employee selected\r\n        load_employee_details(frm);\r\n\r\n        // Check for existing draft requests again\r\n        check_existing_draft(frm);\r\n    }\r\n});\r\n\r\n// üî• Auto-load employee details\r\nasync function load_employee_details(frm) {\r\n    if (!frm.doc.dep_emp_name) return;\r\n\r\n    const emp = await frappe.db.get_value(\r\n        \"Customer Employee Registration\",\r\n        frm.doc.dep_emp_name,\r\n        [\"employee_type\", \"dep_no1\", \"dep_no2\", \"uid_no\"]\r\n    );\r\n\r\n    if (!emp || !emp.message) return;\r\n\r\n    // Build department no (dep_no1/dep_no2)\r\n    let dep_no = \"\";\r\n    if (emp.message.dep_no1) dep_no = emp.message.dep_no1;\r\n    if (emp.message.dep_no2) {\r\n        dep_no = dep_no ? dep_no + \"/\" + emp.message.dep_no2 : emp.message.dep_no2;\r\n    }\r\n\r\n    // Set into Service Request fields\r\n    frm.set_value(\"employee_type\", emp.message.employee_type || \"\");\r\n    frm.set_value(\"department_no\", dep_no || \"\");\r\n    frm.set_value(\"uid_no\", emp.message.uid_no || \"\");\r\n    frm.refresh_fields();\r\n}\r\n\r\n// ‚ö†Ô∏è Check for existing draft Service Request\r\nasync function check_existing_draft(frm) {\r\n    if (!frm.doc.customer || !frm.doc.dep_emp_name) return;\r\n\r\n    const existing = await frappe.db.get_list(\"Service Request\", {\r\n        filters: {\r\n            customer: frm.doc.customer,\r\n            dep_emp_name: frm.doc.dep_emp_name,\r\n            docstatus: 0 // Draft only\r\n        },\r\n        fields: [\"name\"],\r\n        limit: 1\r\n    });\r\n\r\n    if (existing && existing.length > 0 && existing[0].name !== frm.doc.name) {\r\n        frappe.msgprint({\r\n            title: __(\"Warning\"),\r\n            indicator: \"orange\",\r\n            message: __(\"A draft Service Request already exists for this Customer/Employee: <b>{0}</b>\", [existing[0].name])\r\n        });\r\n    }\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Customer Employee Registration",
  "enabled": 1,
  "modified": "2025-11-27 16:25:48.567285",
  "module": "Ag Docs",
  "name": "main_emp_filter",
  "script": "frappe.ui.form.on('Customer Employee Registration', {\n    refresh(frm) {\n        // Only show main employees of the same customer when registering a dependent\n        frm.set_query('dep_emp_name', () => {\n            if (frm.doc.employee_type !== 'Dependent') return {};\n\n            if (!frm.doc.customer_name) {\n                frappe.msgprint(__('Please select a Customer first'));\n                return { filters: { name: ['is', 'set'] } };\n            }\n\n            return {\n                filters: {\n                    customer_name: frm.doc.customer_name,\n                    employee_type: 'Employee'\n                }\n            };\n        });\n\n        // Reset nationality only for brand new documents\n        if (frm.is_new()) {\n            frm.set_value('nationality', '');\n        }\n    },\n\n    customer_name(frm) {\n        // Clear dependent and linked info when customer changes\n        frm.set_value('dep_emp_name', '');\n        frm.set_value('linked_emp_info', '');\n    },\n\n    employee_type(frm) {\n        // Clear dependent and linked info when employee type changes\n        frm.set_value('dep_emp_name', '');\n        frm.set_value('linked_emp_info', '');\n    },\n\n    async dep_emp_name(frm) {\n        // Load linked employee info when dependent employee is selected\n        if (!frm.doc.dep_emp_name) {\n            frm.set_value('linked_emp_info', '');\n            return;\n        }\n\n        try {\n            const emp = await frappe.db.get_doc(\n                'Customer Employee Registration',\n                frm.doc.dep_emp_name\n            );\n\n            const asText = (v) => (v === undefined || v === null) ? '' : String(v).trim();\n\n            const depNo1 = asText(emp.dep_no1 || emp.dep_no_1 || emp.department_no1 || emp.department_no_1);\n            const depNo2 = asText(emp.dep_no2 || emp.dep_no_2 || emp.department_no2 || emp.department_no_2);\n\n            const deptText = [depNo1, depNo2].filter(Boolean).join(' / ');\n            const eidText = asText(emp.eid_no);\n\n            let info = '';\n            if (deptText) info += `Dept: ${deptText}`;\n            if (eidText) info += `${info ? ' | ' : ''}EID: ${eidText}`;\n\n            frm.set_value('linked_emp_info', info || '');\n        } catch (e) {\n            console.error('Failed to load employee:', e);\n            frm.set_value('linked_emp_info', '');\n        }\n    },\n\n    // -----------------------------------------------------\n    // CLEAR FORM AFTER SAVE ‚Üí Opens a new blank document\n    // -----------------------------------------------------\n    after_save(frm) {\n        frappe.new_doc('Customer Employee Registration');\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Service Request",
  "enabled": 0,
  "modified": "2025-11-05 09:14:00.604885",
  "module": "Ag Docs",
  "name": "price_list-fetch",
  "script": "// ----------------------\n// PARENT: Service Request\n// ----------------------\nfrappe.ui.form.on('Service Request', {\n    refresh(frm) {\n        // Always default to Standard Selling if nothing loaded\n        if (!frm.doc.price_list) {\n            frm.set_value('price_list', 'Standard Selling');\n        }\n    },\n\n    async customer_name(frm) {\n        if (!frm.doc.customer_name) {\n            frm.set_value('price_list', 'Standard Selling');\n            return;\n        }\n\n        try {\n            // üîπ Fetch default price list from Customer\n            const { message } = await frappe.db.get_value('Customer', frm.doc.customer_name, ['default_price_list']);\n\n            // Set the price list accordingly\n            const selected_list = message?.default_price_list || 'Standard Selling';\n            await frm.set_value('price_list', selected_list);\n\n            frappe.show_alert({\n                message: `üí∞ Price List set to \"${selected_list}\"`,\n                indicator: 'green'\n            });\n        } catch (e) {\n            console.error('Error fetching customer price list:', e);\n            await frm.set_value('price_list', 'Standard Selling');\n        }\n\n        // üîÅ Ensure it‚Äôs reflected in doc model immediately\n        frm.refresh_field('price_list');\n        await frappe.timeout(0.1); // Give time for async update\n    }\n});\n// ----------------------\n// CHILD: Service Request Item\n// ----------------------\nfrappe.ui.form.on('Service Request Item', {\n    async item_code(frm, cdt, cdn) {\n        const row = locals[cdt][cdn];\n        const item_code = row.item_code;\n        if (!item_code) return;\n\n        // Get price list from parent\n        const price_list = frm.doc.price_list || 'Standard Selling';\n\n        // Fetch Gov Charge\n        let gov_rate = await get_item_rate(item_code, price_list);\n        if (!gov_rate && price_list !== 'Standard Selling') {\n            gov_rate = await get_item_rate(item_code, 'Standard Selling');\n        }\n\n        frappe.model.set_value(cdt, cdn, 'gov_charge', gov_rate || 0);\n\n        // Optional: calculate amount (if amount field exists)\n        if ('amount' in row) {\n            frappe.model.set_value(cdt, cdn, 'amount', (row.qty || 1) * (gov_rate || 0));\n        }\n\n        // Fetch SRV Item Price for optional table\n        const srv_item_code = 'SRV ' + item_code;\n        let srv_rate = await get_item_rate(srv_item_code, price_list);\n        if (!srv_rate && price_list !== 'Standard Selling') {\n            srv_rate = await get_item_rate(srv_item_code, 'Standard Selling');\n        }\n\n        const hasServiceChargeTable = Boolean(frm.fields_dict?.table_sgku);\n\n        if (srv_rate && hasServiceChargeTable) {\n            let srv_row = (frm.doc.table_sgku || []).find(r => r.item_code === srv_item_code);\n            if (!srv_row) {\n                srv_row = frm.add_child('table_sgku', {\n                    item_code: srv_item_code,\n                    qty: row.qty || 1,\n                    service_charge: srv_rate\n                });\n            } else {\n                frappe.model.set_value(srv_row.doctype, srv_row.name, 'service_charge', srv_rate);\n                frappe.model.set_value(srv_row.doctype, srv_row.name, 'qty', row.qty || 1);\n            }\n        } else if (srv_rate && !hasServiceChargeTable) {\n            console.warn('table_sgku field not found on Service Request; skipping SRV item sync');\n        }\n\n        frm.refresh_field('work_details');\n        if (hasServiceChargeTable) {\n            frm.refresh_field('table_sgku');\n        }\n    }\n});\n\n\n// ----------------------\n// Helper: Item Price Fetch\n// ----------------------\nasync function get_item_rate(item_code, price_list) {\n    const { message } = await frappe.db.get_value(\n        'Item Price',\n        { item_code: item_code, price_list: price_list, selling: 1 },\n        ['price_list_rate']\n    );\n    return message ? message.price_list_rate : 0;\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Service Request",
  "enabled": 1,
  "modified": "2025-11-22 11:12:22.259437",
  "module": "Ag Docs",
  "name": "status",
  "script": "// =========================================================\n// Service Request - Working Version (ERPNext 15 compatible)\n// =========================================================\n\nfrappe.ui.form.on(\"Service Request\", {\n    onload(frm) {\n        update_status_summary(frm);\n    },\n    refresh(frm) {\n        update_status_summary(frm);\n    },\n    before_submit(frm) {\n        if (frm.doc.work_details?.length) {\n            const all_completed = frm.doc.work_details.every(\n                row => (row.status || \"\").trim().toLowerCase() === \"completed\"\n            );\n            if (!all_completed) {\n                frappe.throw({\n                    title: __(\"Cannot Submit\"),\n                    message: __(\n                        \"All items must be marked as <b>Completed</b> before submitting.<br><br>\" +\n                        \"Either:<ul><li>Update remaining items to <b>Completed</b></li>\" +\n                        \"<li>Or remove incomplete items from the list</li></ul>\"\n                    )\n                });\n            }\n        }\n    }\n});\n\nfrappe.ui.form.on(\"Service Request Item\", {\n    status(frm) {\n        update_status_summary(frm);\n    },\n    work_details_add(frm) {\n        update_status_summary(frm);\n    },\n    work_details_remove(frm) {\n        update_status_summary(frm);\n    }\n});\n\nfunction update_status_summary(frm) {\n    const table = frm.doc.work_details || [];\n\n    // üõë When CANCELED - remove all colors and tags\n    if (frm.doc.docstatus === 2) {\n        render_html(frm, `<span style=\"color:gray;\">Canceled ‚Äî status not applicable</span>`);\n        frm.page.set_indicator(\"Canceled\", \"gray\");\n        return;\n    }\n\n    if (!table.length) {\n        render_html(frm, `<span style=\"color:gray;\">No items yet</span>`);\n        frm.page.set_indicator(\"No Items\", \"gray\");\n        return;\n    }\n\n    // Count all statuses\n    const counts = {};\n    table.forEach(row => {\n        const status = (row.status || \"\").trim();\n        if (!status) return;\n        counts[status] = (counts[status] || 0) + 1;\n    });\n\n    // Color map (still used only if not canceled)\n    const color_map = {\n        \"Pending\": \"red\",\n        \"Waiting for Payment\": \"orange\",\n        \"Completed\": \"green\"\n    };\n\n    // Build HTML with counts\n    const html_parts = Object.entries(counts).map(([status, count]) => {\n        return `<span style=\"font-weight:500;\">‚óè ${status} (${count})</span>`;\n    });\n\n    const html = `<div style=\"font-size:13px; line-height:1.6;\">${html_parts.join(\" &nbsp;|&nbsp; \")}</div>`;\n    render_html(frm, html);\n\n    // Header indicator\n    const all_completed = Object.keys(counts).length === 1 && counts[\"Completed\"] === table.length;\n\n    if (all_completed) {\n        frm.page.set_indicator(\"All Completed\", \"green\");\n    } else if (counts[\"Waiting for Payment\"]) {\n        frm.page.set_indicator(\"Waiting for Payment\", \"orange\");\n    } else if (counts[\"Pending\"]) {\n        frm.page.set_indicator(\"Pending\", \"red\");\n    } else {\n        frm.page.set_indicator(\"In Progress\", \"gray\");\n    }\n}\n\n// ‚úÖ Correct rendering for ERPNext 15 HTML field\nfunction render_html(frm, html) {\n    const field = frm.fields_dict[\"status_summary\"];\n    if (!field) {\n        console.warn(\"‚ö†Ô∏è status_summary field not found\");\n        return;\n    }\n    if (!field.$wrapper) {\n        frappe.ui.form.on(\"Service Request\", {\n            refresh(frm) {\n                frm.fields_dict[\"status_summary\"].$wrapper.html(html);\n            }\n        });\n        return;\n    }\n    field.$wrapper.html(html);\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Service Request",
  "enabled": 0,
  "modified": "2025-11-05 09:13:23.268536",
  "module": "Ag Docs",
  "name": "sale_order_cu",
  "script": "frappe.ui.form.on('Service Request', {\n    refresh(frm) {\n\n        // --- Create Sales Order ---\n        if (!frm.is_new()) {\n            frm.add_custom_button(__('Create Sales Order'), () => {\n                frappe.call({\n                    method: \"service_workorder.api.create_sales_order_from_service_request\",\n                    args: { service_request: frm.doc.name },\n                    callback: function(r) {\n                        if (r.message) {\n                            frappe.model.sync(r.message);\n                            frappe.set_route(\"Form\", r.message.doctype, r.message.name);\n                        }\n                    }\n                });\n            }, __('Create'));\n        }\n\n        // --- Create Sales Invoice ---\n        if (frm.doc.docstatus === 1 && !frm.doc.sales_order_ref) {\n            frm.add_custom_button(__('Create Sales Invoice'), () => {\n                frappe.call({\n                    method: \"service_workorder.api.create_sales_invoice_from_service_request\",\n                    args: { service_request: frm.doc.name },\n                    callback: function(r) {\n                        if (r.message) {\n                            frappe.model.sync(r.message);\n                            frappe.set_route(\"Form\", r.message.doctype, r.message.name);\n                        }\n                    }\n                });\n            }, __('Create'));\n        }\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Service Request",
  "enabled": 0,
  "modified": "2025-11-20 18:34:42.385434",
  "module": "Ag Docs",
  "name": "Diagnostic Script",
  "script": "// ======================================================\n// Helper Functions\n// ======================================================\n\n// 1Ô∏è‚É£ Rebuild \"Taxes and Charges\" (table_sgku)\nfunction update_taxes_from_items(frm) {\n  if (!frm.fields_dict?.table_sgku) {\n    return;\n  }\n  frm.clear_table(\"table_sgku\");\n\n  let total_service_charge = 0;\n  (frm.doc.work_details || []).forEach(row => {\n    total_service_charge += (flt(row.service_charge) || 0) * (flt(row.qty) || 0);\n  });\n\n  if (total_service_charge > 0) {\n    const t = frm.add_child(\"table_sgku\");\n    t.account_head = \"Service Charges Income\";  // üîÅ adjust if needed\n    t.charge_type = \"Actual\";\n    t.tax_amount = total_service_charge;\n\n    // ‚úÖ Fix for \"Missing Description\" validation\n    t.description = \"Total Service Charges\";  // üëà Default text for mandatory field\n  }\n\n  frm.refresh_field(\"table_sgku\");\n  console.log(\"‚úÖ Taxes updated ‚Üí\", total_service_charge);\n}\n\n// 2Ô∏è‚É£ Fetch slab linked to customer\nasync function fetch_customer_slab(customer, company) {\n  if (!customer || !company) return null;\n\n  const res = await frappe.db.get_list(\"Customer Service Charge Link\", {\n    filters: { customer, company, enabled: 1 },\n    fields: [\"service_charge_slab\"],\n    limit: 1\n  });\n  return (res && res.length) ? res[0].service_charge_slab : null;\n}\n\n// 3Ô∏è‚É£ Fetch item-specific service charge from slab\nasync function fetch_item_service_charge(slab_name, item_code) {\n  if (!slab_name || !item_code) return null;\n\n  const rows = await frappe.db.get_list(\"Service Charge Slab Item\", {\n    filters: { parent: slab_name, item: item_code },\n    fields: [\"service_charge\", \"tax_applicable\"],\n    limit: 1\n  });\n  return (rows && rows.length) ? rows[0] : null;\n}\n\n// 4Ô∏è‚É£ Row amount recalculation (with frappe.model.set_value)\nfunction recalc_row_amount(frm, cdt, cdn) {\n  const row = locals[cdt][cdn];\n  const qty = flt(row.qty) || 0;\n  const gov = flt(row.gov_charge) || 0;\n  const srv = flt(row.service_charge) || 0;\n  const amount = qty * (gov + srv);\n\n  frappe.model.set_value(cdt, cdn, \"amount\", amount);\n}\n\n// ======================================================\n// Form Events ‚Äì Service Request\n// ======================================================\n\nfrappe.ui.form.on(\"Service Request\", {\n  async customer(frm) {\n    if (!frm.doc.customer || !frm.doc.company) return;\n\n    const slab = await fetch_customer_slab(frm.doc.customer, frm.doc.company);\n    if (!slab) {\n      frappe.msgprint(\"‚ö†Ô∏è No active Service Charge Slab found for this Customer + Company.\");\n      frm.set_value(\"service_charge_slab\", \"\");\n      return;\n    }\n\n    await frm.set_value(\"service_charge_slab\", slab);\n    frappe.show_alert({ message: `Loaded Service Charge Slab: ${slab}`, indicator: \"green\" });\n    console.log(\"Loaded slab:\", slab);\n\n    // Apply slab to existing rows\n    for (const row of (frm.doc.work_details || [])) {\n      if (!row.item_code) continue;\n      const r = await fetch_item_service_charge(slab, row.item_code);\n      frappe.model.set_value(row.doctype, row.name, \"service_charge\", r ? r.service_charge : 0);\n      recalc_row_amount(frm, row.doctype, row.name);\n    }\n\n    frm.refresh_field(\"work_details\");\n    update_taxes_from_items(frm);\n  },\n\n refresh(frm) {\n    if (!frm.is_new() && frm.doc.work_details) {\n        update_taxes_from_items(frm);\n    }\n},\n\nvalidate(frm) {\n    // Run AFTER all fields are loaded\n    setTimeout(() => update_taxes_from_items(frm), 50);\n},\n\n\n  work_details_add(frm) {\n    update_taxes_from_items(frm);\n  },\n\n  work_details_remove(frm) {\n    update_taxes_from_items(frm);\n  }\n});\n\n// ======================================================\n// Child Table Events ‚Äì Service Request Item\n// ======================================================\n\nfrappe.ui.form.on(\"Service Request Item\", {\n  item_code(frm, cdt, cdn) {\n    const row = locals[cdt][cdn];\n\n    if (!frm.doc.service_charge_slab) {\n      frappe.msgprint(\"‚ö†Ô∏è Select a customer with a valid Service Charge Slab first.\");\n      return;\n    }\n\n    if (!row.item_code) return;\n\n   frappe.call({\n  method: \"service_workorder.api.get_service_charge_from_slab\",\n  args: { slab_name: frm.doc.service_charge_slab, item_code: row.item_code },\n  callback: function (r) {\n    const srv = (r.message && r.message.service_charge) || 0;\n    frappe.model.set_value(cdt, cdn, \"service_charge\", srv);\n    recalc_row_amount(frm, cdt, cdn);\n    update_taxes_from_items(frm);\n  }\n});\n\n  },\n\n  qty(frm, cdt, cdn) {\n    recalc_row_amount(frm, cdt, cdn);\n    update_taxes_from_items(frm);\n  },\n\n  gov_charge(frm, cdt, cdn) {\n    recalc_row_amount(frm, cdt, cdn);\n    update_taxes_from_items(frm);\n  },\n\n  service_charge(frm, cdt, cdn) {\n    recalc_row_amount(frm, cdt, cdn);\n    update_taxes_from_items(frm);\n  }\n});\n",
  "view": "Form"
 }
]