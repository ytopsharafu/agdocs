[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Customer Employee Registration",
  "enabled": 1,
  "modified": "2025-11-05 09:14:26.427147",
  "module": "Ag Docs",
  "name": "full_name",
  "script": "frappe.ui.form.on('Customer Employee Registration', {\n    first_name: function(frm) {\n        frm.set_value('full_name', (frm.doc.first_name || '') + ' ' + (frm.doc.last_name || ''));\n    },\n    last_name: function(frm) {\n        frm.set_value('full_name', (frm.doc.first_name || '') + ' ' + (frm.doc.last_name || ''));\n    },\n    employee_type: function(frm) {\n        if (frm.doc.employee_type === 'Dependent') {\n            frm.set_df_property('link_employee', 'hidden', 0);\n        } else {\n            frm.set_df_property('link_employee', 'hidden', 1);\n        }\n    },\n    customer: function(frm) {\n        frm.set_query('link_employee', function() {\n            return {\n                filters: {\n                    customer: frm.doc.customer,\n                    employee_type: 'Employee'\n                }\n            };\n        });\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Service Request",
  "enabled": 1,
  "modified": "2025-11-05 09:12:51.854404",
  "module": "Ag Docs",
  "name": "emp_filter",
  "script": "frappe.ui.form.on('Service Request', {\n    refresh(frm) {\n        // Filter employee list by selected customer\n        frm.set_query('dep_emp_name', () => {\n            if (!frm.doc.customer) {\n                frappe.msgprint(__('Please select a Customer first'));\n                return { filters: { name: ['is', 'set'] } };\n            }\n            return { filters: { customer_name: frm.doc.customer } };\n        });\n    },\n\n    async dep_emp_name(frm) {\n        // Clear old data\n        frm.set_value({\n            employee_type: '',\n            department_no: '',\n            eid_no: '',\n            main_employee_name: ''\n        });\n\n        if (!frm.doc.dep_emp_name) return;\n\n        const { message: emp } = await frappe.db.get_value(\n            'Customer Employee Registration',\n            frm.doc.dep_emp_name,\n            ['employee_type', 'dep_emp_name', 'dep_no1', 'dep_no2', 'eid_no']\n        );\n        if (!emp) return;\n\n        const eid = emp.eid_no || '';\n        const type = emp.employee_type || '';\n        const dept_self = [emp.dep_no1, emp.dep_no2].filter(Boolean).join('/') || '';\n\n        if (type === 'Dependent' && emp.dep_emp_name) {\n            // Fetch main employee‚Äôs department info\n            const { message: main } = await frappe.db.get_value(\n                'Customer Employee Registration',\n                emp.dep_emp_name,\n                ['dep_no1', 'dep_no2', 'dep_emp_name']\n            );\n\n            const main_dept = [main?.dep_no1, main?.dep_no2].filter(Boolean).join('/') || '';\n\n            frm.set_value({\n                employee_type: type,\n                department_no: main_dept,\n                eid_no: eid,\n                main_employee_name: main?.dep_emp_name || ''\n            });\n        } else {\n            frm.set_value({\n                employee_type: type,\n                department_no: dept_self,\n                eid_no: eid\n            });\n        }\n        frm.refresh_fields();\n    },\n\n    // üîÑ When Customer changes or cleared\n    customer(frm) {\n        // Reset employee + pricing details\n        frm.set_value({\n            dep_emp_name: '',\n            employee_type: '',\n            department_no: '',\n            eid_no: '',\n            main_employee_name: '',\n            service_charge_slab: '',\n        });\n\n        // Clear rate/service charge/gov_charge/amount in all rows\n        if (frm.doc.details && frm.doc.details.length > 0) {\n            frm.doc.details.forEach(row => {\n                frappe.model.set_value(row.doctype, row.name, 'rate', 0);\n                frappe.model.set_value(row.doctype, row.name, 'service_charge', 0);\n                frappe.model.set_value(row.doctype, row.name, 'gov_charge', 0);\n                frappe.model.set_value(row.doctype, row.name, 'amount', 0);\n            });\n        }\n\n        frm.refresh_fields();\n    },\n\n    dep_emp_name_clear(frm) {\n        frm.set_value({\n            employee_type: '',\n            department_no: '',\n            eid_no: '',\n            main_employee_name: ''\n        });\n    }\n});\n\n\n// üß© Item child table logic\nfrappe.ui.form.on('Service Request Detail', {\n    // When item changes\n    item(frm, cdt, cdn) {\n        const row = locals[cdt][cdn];\n        frappe.model.set_value(cdt, cdn, 'rate', 0);\n        frappe.model.set_value(cdt, cdn, 'service_charge', 0);\n        frappe.model.set_value(cdt, cdn, 'gov_charge', 0);\n        frappe.model.set_value(cdt, cdn, 'amount', 0);\n    },\n\n    // When a row is removed\n    details_remove(frm) {\n        // Recalculate total if needed\n        let total = 0;\n        (frm.doc.details || []).forEach(d => {\n            total += flt(d.amount);\n        });\n        frm.set_value('total_amount', total);\n        frm.refresh_field('total_amount');\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Customer Employee Registration",
  "enabled": 1,
  "modified": "2025-11-05 09:14:18.192616",
  "module": "Ag Docs",
  "name": "main_emp_filter",
  "script": "frappe.ui.form.on('Customer Employee Registration', {\n    refresh(frm) {\n        // Only show main employees of the same customer when registering a dependent\n        frm.set_query('dep_emp_name', () => {\n            if (frm.doc.employee_type !== 'Dependent') return {};\n            if (!frm.doc.customer_name) {\n                frappe.msgprint(__('Please select a Customer first'));\n                return { filters: { name: ['is', 'set'] } };\n            }\n            return {\n                filters: {\n                    customer_name: frm.doc.customer_name,\n                    employee_type: 'Employee'\n                }\n            };\n        });\n    },\n\n    // Clear on key changes\n    customer_name(frm) {\n        frm.set_value('dep_emp_name', '');\n        frm.set_value('linked_emp_info', '');\n    },\n    employee_type(frm) {\n        frm.set_value('dep_emp_name', '');\n        frm.set_value('linked_emp_info', '');\n    },\n\n    // Populate compact info when linked employee changes (or clear if removed)\n    async dep_emp_name(frm) {\n        if (!frm.doc.dep_emp_name) {\n            frm.set_value('linked_emp_info', '');\n            return;\n        }\n\n        try {\n            const emp = await frappe.db.get_doc('Customer Employee Registration', frm.doc.dep_emp_name);\n\n            // Helper to coerce any value to trimmed text\n            const asText = (v) => (v === undefined || v === null) ? '' : String(v).trim();\n\n            // Read both dep numbers (support common naming variants just in case)\n            const depNo1 = asText(emp.dep_no1 || emp.dep_no_1 || emp.department_no1 || emp.department_no_1);\n            const depNo2 = asText(emp.dep_no2 || emp.dep_no_2 || emp.department_no2 || emp.department_no_2);\n\n            // Join both if present; show either/both\n            const deptText = [depNo1, depNo2].filter(Boolean).join(' / ');\n\n            // EID (text safe)\n            const eidText = asText(emp.eid_no);\n\n            // Build final display (no name, per your request)\n            let info = '';\n            if (deptText) info += `Dept: ${deptText}`;\n            if (eidText)  info += `${info ? ' | ' : ''}EID: ${eidText}`;\n\n            frm.set_value('linked_emp_info', info || '');\n        } catch (e) {\n            console.error('Failed to fetch linked employee:', e);\n            frm.set_value('linked_emp_info', '');\n        }\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Service Request",
  "enabled": 1,
  "modified": "2025-11-05 09:14:00.604885",
  "module": "Ag Docs",
  "name": "price_list-fetch",
  "script": "// ----------------------\n// PARENT: Service Request\n// ----------------------\nfrappe.ui.form.on('Service Request', {\n    refresh(frm) {\n        // Always default to Standard Selling if nothing loaded\n        if (!frm.doc.price_list) {\n            frm.set_value('price_list', 'Standard Selling');\n        }\n    },\n\n    customer_name: async function (frm) {\n        if (!frm.doc.customer_name) {\n            frm.set_value('price_list', 'Standard Selling');\n            return;\n        }\n\n        try {\n            // üîπ Fetch default price list from Customer\n            const { message } = await frappe.db.get_value('Customer', frm.doc.customer_name, ['default_price_list']);\n\n            // Set the price list accordingly\n            const selected_list = message?.default_price_list || 'Standard Selling';\n            await frm.set_value('price_list', selected_list);\n\n            frappe.show_alert({\n                message: `üí∞ Price List set to \"${selected_list}\"`,\n                indicator: 'green'\n            });\n        } catch (e) {\n            console.error('Error fetching customer price list:', e);\n            await frm.set_value('price_list', 'Standard Selling');\n        }\n\n        // üîÅ Ensure it‚Äôs reflected in doc model immediately\n        frm.refresh_field('price_list');\n        await frappe.timeout(0.1); // Give time for async update\n    }\n});\n// ----------------------\n// CHILD: Service Request Item\n// ----------------------\nfrappe.ui.form.on('Service Request Item', {\n    async item_code(frm, cdt, cdn) {\n        const row = locals[cdt][cdn];\n        const item_code = row.item_code;\n        if (!item_code) return;\n\n        // Get price list from parent\n        const price_list = frm.doc.price_list || 'Standard Selling';\n\n        // Fetch Gov Charge\n        let gov_rate = await get_item_rate(item_code, price_list);\n        if (!gov_rate && price_list !== 'Standard Selling') {\n            gov_rate = await get_item_rate(item_code, 'Standard Selling');\n        }\n\n        frappe.model.set_value(cdt, cdn, 'gov_charge', gov_rate || 0);\n\n        // Optional: calculate amount (if amount field exists)\n        if ('amount' in row) {\n            frappe.model.set_value(cdt, cdn, 'amount', (row.qty || 1) * (gov_rate || 0));\n        }\n\n        // Fetch SRV Item Price\n        const srv_item_code = 'SRV ' + item_code;\n        let srv_rate = await get_item_rate(srv_item_code, price_list);\n        if (!srv_rate && price_list !== 'Standard Selling') {\n            srv_rate = await get_item_rate(srv_item_code, 'Standard Selling');\n        }\n\n        if (srv_rate) {\n            let srv_row = (frm.doc.table_sgku || []).find(r => r.item_code === srv_item_code);\n            if (!srv_row) {\n                srv_row = frm.add_child('table_sgku', {\n                    item_code: srv_item_code,\n                    qty: row.qty || 1,\n                    service_charge: srv_rate\n                });\n            } else {\n                frappe.model.set_value(srv_row.doctype, srv_row.name, 'service_charge', srv_rate);\n                frappe.model.set_value(srv_row.doctype, srv_row.name, 'qty', row.qty || 1);\n            }\n        }\n\n        frm.refresh_field('work_details');\n        frm.refresh_field('table_sgku');\n    }\n});\n\n\n// ----------------------\n// Helper: Item Price Fetch\n// ----------------------\nasync function get_item_rate(item_code, price_list) {\n    const { message } = await frappe.db.get_value(\n        'Item Price',\n        { item_code: item_code, price_list: price_list, selling: 1 },\n        ['price_list_rate']\n    );\n    return message ? message.price_list_rate : 0;\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Service Request",
  "enabled": 1,
  "modified": "2025-11-05 09:13:38.444887",
  "module": "Ag Docs",
  "name": "status",
  "script": "// =========================================================\n// Service Request - Working Version (ERPNext 15 compatible)\n// =========================================================\n\nfrappe.ui.form.on(\"Service Request\", {\n    onload(frm) {\n        update_status_summary(frm);\n    },\n    refresh(frm) {\n        update_status_summary(frm);\n    },\n    before_submit(frm) {\n        if (frm.doc.work_details?.length) {\n            const all_completed = frm.doc.work_details.every(\n                row => (row.status || \"\").trim().toLowerCase() === \"completed\"\n            );\n            if (!all_completed) {\n                frappe.throw({\n                    title: __(\"Cannot Submit\"),\n                    message: __(\n                        \"All items must be marked as <b>Completed</b> before submitting.<br><br>\" +\n                        \"Either:<ul><li>Update remaining items to <b>Completed</b></li>\" +\n                        \"<li>Or remove incomplete items from the list</li></ul>\"\n                    )\n                });\n            }\n        }\n    }\n});\n\nfrappe.ui.form.on(\"Service Request Item\", {\n    status(frm) {\n        update_status_summary(frm);\n    },\n    work_details_add(frm) {\n        update_status_summary(frm);\n    },\n    work_details_remove(frm) {\n        update_status_summary(frm);\n    }\n});\n\nfunction update_status_summary(frm) {\n    const table = frm.doc.work_details || [];\n\n    if (!table.length) {\n        render_html(frm, `<span style=\"color:gray;\">No items yet</span>`);\n        frm.page.set_indicator(\"No Items\", \"gray\");\n        return;\n    }\n\n    // Count all statuses\n    const counts = {};\n    table.forEach(row => {\n        const status = (row.status || \"\").trim();\n        if (!status) return;\n        counts[status] = (counts[status] || 0) + 1;\n    });\n\n    // Color map\n    const color_map = {\n        \"Pending\": \"red\",\n        \"Waiting for Payment\": \"orange\",\n        \"Completed\": \"green\"\n    };\n\n    // Build HTML with counts\n    const html_parts = Object.entries(counts).map(([status, count]) => {\n        const color = color_map[status] || \"gray\";\n        return `<span style=\"color:${color}; font-weight:500;\">‚óè ${status} (${count})</span>`;\n    });\n\n    const html = `<div style=\"font-size:13px; line-height:1.6;\">${html_parts.join(\" &nbsp;|&nbsp; \")}</div>`;\n    render_html(frm, html);\n\n    // Header indicator\n    const all_completed = Object.keys(counts).length === 1 && counts[\"Completed\"] === table.length;\n    if (all_completed) {\n        frm.page.set_indicator(\"All Completed\", \"green\");\n    } else if (counts[\"Waiting for Payment\"]) {\n        frm.page.set_indicator(\"Waiting for Payment\", \"orange\");\n    } else if (counts[\"Pending\"]) {\n        frm.page.set_indicator(\"Pending\", \"red\");\n    } else {\n        frm.page.set_indicator(\"In Progress\", \"gray\");\n    }\n}\n\n// ‚úÖ Correct rendering for ERPNext 15 HTML field\nfunction render_html(frm, html) {\n    const field = frm.fields_dict[\"status_summary\"];\n    if (!field) {\n        console.warn(\"‚ö†Ô∏è status_summary field not found\");\n        return;\n    }\n    if (!field.$wrapper) {\n        frappe.ui.form.on(\"Service Request\", {\n            refresh(frm) {\n                frm.fields_dict[\"status_summary\"].$wrapper.html(html);\n            }\n        });\n        return;\n    }\n    field.$wrapper.html(html);\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Service Request",
  "enabled": 1,
  "modified": "2025-11-05 09:13:23.268536",
  "module": "Ag Docs",
  "name": "sale_order_cu",
  "script": "frappe.ui.form.on('Service Request', {\n    refresh(frm) {\n\n        // --- Create Sales Order ---\n        if (!frm.is_new()) {\n            frm.add_custom_button(__('Create Sales Order'), () => {\n                frappe.call({\n                    method: \"service_workorder.api.create_sales_order_from_service_request\",\n                    args: { service_request: frm.doc.name },\n                    callback: function(r) {\n                        if (r.message) {\n                            frappe.model.sync(r.message);\n                            frappe.set_route(\"Form\", r.message.doctype, r.message.name);\n                        }\n                    }\n                });\n            }, __('Create'));\n        }\n\n        // --- Create Sales Invoice ---\n        if (frm.doc.docstatus === 1 && !frm.doc.sales_order_ref) {\n            frm.add_custom_button(__('Create Sales Invoice'), () => {\n                frappe.call({\n                    method: \"service_workorder.api.create_sales_invoice_from_service_request\",\n                    args: { service_request: frm.doc.name },\n                    callback: function(r) {\n                        if (r.message) {\n                            frappe.model.sync(r.message);\n                            frappe.set_route(\"Form\", r.message.doctype, r.message.name);\n                        }\n                    }\n                });\n            }, __('Create'));\n        }\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Service Request",
  "enabled": 1,
  "modified": "2025-11-05 09:13:11.735383",
  "module": "Ag Docs",
  "name": "Diagnostic Script",
  "script": "// ======================================================\n// Helper Functions\n// ======================================================\n\n// 1Ô∏è‚É£ Rebuild \"Taxes and Charges\" (table_sgku)\nfunction update_taxes_from_items(frm) {\n  frm.clear_table(\"table_sgku\");\n\n  let total_service_charge = 0;\n  (frm.doc.work_details || []).forEach(row => {\n    total_service_charge += (flt(row.service_charge) || 0) * (flt(row.qty) || 0);\n  });\n\n  if (total_service_charge > 0) {\n    const t = frm.add_child(\"table_sgku\");\n    t.account_head = \"Service Charges Income\";  // üîÅ adjust if needed\n    t.charge_type = \"Actual\";\n    t.tax_amount = total_service_charge;\n\n    // ‚úÖ Fix for \"Missing Description\" validation\n    t.description = \"Total Service Charges\";  // üëà Default text for mandatory field\n  }\n\n  frm.refresh_field(\"table_sgku\");\n  console.log(\"‚úÖ Taxes updated ‚Üí\", total_service_charge);\n}\n\n// 2Ô∏è‚É£ Fetch slab linked to customer\nasync function fetch_customer_slab(customer, company) {\n  if (!customer || !company) return null;\n\n  const res = await frappe.db.get_list(\"Customer Service Charge Link\", {\n    filters: { customer, company, enabled: 1 },\n    fields: [\"service_charge_slab\"],\n    limit: 1\n  });\n  return (res && res.length) ? res[0].service_charge_slab : null;\n}\n\n// 3Ô∏è‚É£ Fetch item-specific service charge from slab\nasync function fetch_item_service_charge(slab_name, item_code) {\n  if (!slab_name || !item_code) return null;\n\n  const rows = await frappe.db.get_list(\"Service Charge Slab Item\", {\n    filters: { parent: slab_name, item: item_code },\n    fields: [\"service_charge\", \"tax_applicable\"],\n    limit: 1\n  });\n  return (rows && rows.length) ? rows[0] : null;\n}\n\n// 4Ô∏è‚É£ Row amount recalculation (with frappe.model.set_value)\nfunction recalc_row_amount(frm, cdt, cdn) {\n  const row = locals[cdt][cdn];\n  const qty = flt(row.qty) || 0;\n  const gov = flt(row.gov_charge) || 0;\n  const srv = flt(row.service_charge) || 0;\n  const amount = qty * (gov + srv);\n\n  frappe.model.set_value(cdt, cdn, \"amount\", amount);\n}\n\n// ======================================================\n// Form Events ‚Äì Service Request\n// ======================================================\n\nfrappe.ui.form.on(\"Service Request\", {\n  async customer(frm) {\n    if (!frm.doc.customer || !frm.doc.company) return;\n\n    const slab = await fetch_customer_slab(frm.doc.customer, frm.doc.company);\n    if (!slab) {\n      frappe.msgprint(\"‚ö†Ô∏è No active Service Charge Slab found for this Customer + Company.\");\n      frm.set_value(\"service_charge_slab\", \"\");\n      return;\n    }\n\n    await frm.set_value(\"service_charge_slab\", slab);\n    frappe.show_alert({ message: `Loaded Service Charge Slab: ${slab}`, indicator: \"green\" });\n    console.log(\"Loaded slab:\", slab);\n\n    // Apply slab to existing rows\n    for (const row of (frm.doc.work_details || [])) {\n      if (!row.item_code) continue;\n      const r = await fetch_item_service_charge(slab, row.item_code);\n      frappe.model.set_value(row.doctype, row.name, \"service_charge\", r ? r.service_charge : 0);\n      recalc_row_amount(frm, row.doctype, row.name);\n    }\n\n    frm.refresh_field(\"work_details\");\n    update_taxes_from_items(frm);\n  },\n\n  refresh(frm) {\n    update_taxes_from_items(frm);\n  },\n\n  validate(frm) {\n    update_taxes_from_items(frm);\n  },\n\n  work_details_add(frm) {\n    update_taxes_from_items(frm);\n  },\n\n  work_details_remove(frm) {\n    update_taxes_from_items(frm);\n  }\n});\n\n// ======================================================\n// Child Table Events ‚Äì Service Request Item\n// ======================================================\n\nfrappe.ui.form.on(\"Service Request Item\", {\n  item_code(frm, cdt, cdn) {\n    const row = locals[cdt][cdn];\n\n    if (!frm.doc.service_charge_slab) {\n      frappe.msgprint(\"‚ö†Ô∏è Select a customer with a valid Service Charge Slab first.\");\n      return;\n    }\n\n    if (!row.item_code) return;\n\n    frappe.call({\n      method: \"service_workorder.api.get_item_service_charge\",\n      args: { slab: frm.doc.service_charge_slab, item: row.item_code },\n      callback: function (r) {\n        const srv = (r.message && r.message.service_charge) || 0;\n        frappe.model.set_value(cdt, cdn, \"service_charge\", srv);\n        recalc_row_amount(frm, cdt, cdn);\n        update_taxes_from_items(frm);\n      }\n    });\n  },\n\n  qty(frm, cdt, cdn) {\n    recalc_row_amount(frm, cdt, cdn);\n    update_taxes_from_items(frm);\n  },\n\n  gov_charge(frm, cdt, cdn) {\n    recalc_row_amount(frm, cdt, cdn);\n    update_taxes_from_items(frm);\n  },\n\n  service_charge(frm, cdt, cdn) {\n    recalc_row_amount(frm, cdt, cdn);\n    update_taxes_from_items(frm);\n  }\n});\n",
  "view": "Form"
 }
]